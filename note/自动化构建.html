<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>自动化构建 | 橘子</title>
    <meta name="generator" content="VuePress 1.5.3">
    <link rel="icon" href="/blog/favicon.ico">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="mask-icon" href="/blog/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <meta name="description" content="明日可期">
    <meta name="author" content="bright">
    <meta name="keywords" content="前端 随记 笔记">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileColor" content="#000000">
    <link rel="preload" href="/blog/assets/css/0.styles.8a31d08e.css" as="style"><link rel="preload" href="/blog/assets/js/app.7268b5d5.js" as="script"><link rel="preload" href="/blog/assets/js/2.bfb3ed95.js" as="script"><link rel="preload" href="/blog/assets/js/27.2fd5153a.js" as="script"><link rel="preload" href="/blog/assets/js/3.38b041cb.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.e22ab2a4.js"><link rel="prefetch" href="/blog/assets/js/11.9b6afde3.js"><link rel="prefetch" href="/blog/assets/js/12.1881e8b2.js"><link rel="prefetch" href="/blog/assets/js/13.591e9158.js"><link rel="prefetch" href="/blog/assets/js/14.03b9db9c.js"><link rel="prefetch" href="/blog/assets/js/15.8acf6f69.js"><link rel="prefetch" href="/blog/assets/js/16.887430fe.js"><link rel="prefetch" href="/blog/assets/js/17.018b2b77.js"><link rel="prefetch" href="/blog/assets/js/18.dcc85b92.js"><link rel="prefetch" href="/blog/assets/js/19.c9b2a5b0.js"><link rel="prefetch" href="/blog/assets/js/20.cd933d25.js"><link rel="prefetch" href="/blog/assets/js/21.5887b2f8.js"><link rel="prefetch" href="/blog/assets/js/22.5cb0bf92.js"><link rel="prefetch" href="/blog/assets/js/23.bff58062.js"><link rel="prefetch" href="/blog/assets/js/24.145710ef.js"><link rel="prefetch" href="/blog/assets/js/25.6e7a99f7.js"><link rel="prefetch" href="/blog/assets/js/26.6251e442.js"><link rel="prefetch" href="/blog/assets/js/28.68c69371.js"><link rel="prefetch" href="/blog/assets/js/4.a5e4891f.js"><link rel="prefetch" href="/blog/assets/js/5.7165873c.js"><link rel="prefetch" href="/blog/assets/js/6.f680b873.js"><link rel="prefetch" href="/blog/assets/js/7.17ca32f2.js"><link rel="prefetch" href="/blog/assets/js/8.7acd39b4.js"><link rel="prefetch" href="/blog/assets/js/9.f5c94ac4.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.8a31d08e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">橘子</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/network/" class="nav-link">
  浏览器
</a></div><div class="nav-item"><a href="/blog/note/ES6.html" class="nav-link">
  随记
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/frame/Vue/base.html" class="nav-link">
  Vue
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/network/" class="nav-link">
  浏览器
</a></div><div class="nav-item"><a href="/blog/note/ES6.html" class="nav-link">
  随记
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/frame/Vue/base.html" class="nav-link">
  Vue
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>note</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/note/ES6.html" class="sidebar-link">ES 新特性</a></li><li><a href="/blog/note/EventLoop.html" class="sidebar-link">EventLoop</a></li><li><a href="/blog/note/FP.html" class="sidebar-link">函数式编程(FP)</a></li><li><a href="/blog/note/JS性能优化.html" class="sidebar-link">JS性能优化</a></li><li><a href="/blog/note/Promise.html" class="sidebar-link">Promise源码实现诱导版</a></li><li><a href="/blog/note/" aria-current="page" class="sidebar-link">日常随记</a></li><li><a href="/blog/note/Rollup.html" class="sidebar-link">Rollup</a></li><li><a href="/blog/note/TS.html" class="sidebar-link">TypeScript</a></li><li><a href="/blog/note/webpack.html" class="sidebar-link">Webpack</a></li><li><a href="/blog/note/工程化.html" class="sidebar-link">工程化</a></li><li><a href="/blog/note/脚手架工具.html" class="sidebar-link">脚手架工具</a></li><li><a href="/blog/note/自动化构建.html" class="active sidebar-link">自动化构建</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/note/自动化构建.html#常用自动化构建工具" class="sidebar-link">常用自动化构建工具</a></li><li class="sidebar-sub-header"><a href="/blog/note/自动化构建.html#grunt" class="sidebar-link">Grunt</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/note/自动化构建.html#基本使用" class="sidebar-link">基本使用</a></li><li class="sidebar-sub-header"><a href="/blog/note/自动化构建.html#异步任务" class="sidebar-link">异步任务</a></li><li class="sidebar-sub-header"><a href="/blog/note/自动化构建.html#grunt标记任务失败" class="sidebar-link">Grunt标记任务失败</a></li><li class="sidebar-sub-header"><a href="/blog/note/自动化构建.html#grunt-的配置方法" class="sidebar-link">Grunt 的配置方法</a></li><li class="sidebar-sub-header"><a href="/blog/note/自动化构建.html#grunt-多目标任务" class="sidebar-link">Grunt 多目标任务</a></li><li class="sidebar-sub-header"><a href="/blog/note/自动化构建.html#grunt-插件的使用" class="sidebar-link">Grunt 插件的使用</a></li><li class="sidebar-sub-header"><a href="/blog/note/自动化构建.html#grunt-常用插件" class="sidebar-link">Grunt 常用插件</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/note/自动化构建.html#gulp" class="sidebar-link">Gulp</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/note/自动化构建.html#基本使用-2" class="sidebar-link">基本使用</a></li><li class="sidebar-sub-header"><a href="/blog/note/自动化构建.html#组合任务" class="sidebar-link">组合任务</a></li><li class="sidebar-sub-header"><a href="/blog/note/自动化构建.html#异步任务-2" class="sidebar-link">异步任务</a></li><li class="sidebar-sub-header"><a href="/blog/note/自动化构建.html#gulp-构建过程核心工作原理" class="sidebar-link">Gulp 构建过程核心工作原理</a></li><li class="sidebar-sub-header"><a href="/blog/note/自动化构建.html#gulp-文件操作-api-插件的使用" class="sidebar-link">Gulp 文件操作 API + 插件的使用</a></li><li class="sidebar-sub-header"><a href="/blog/note/自动化构建.html#gulp-自动化构建案例" class="sidebar-link">Gulp 自动化构建案例</a></li><li class="sidebar-sub-header"><a href="/blog/note/自动化构建.html#图标和字体文件转换" class="sidebar-link">图标和字体文件转换</a></li><li class="sidebar-sub-header"><a href="/blog/note/自动化构建.html#其他文件的拷贝和文件的清除" class="sidebar-link">其他文件的拷贝和文件的清除</a></li><li class="sidebar-sub-header"><a href="/blog/note/自动化构建.html#插件的自动加载" class="sidebar-link">插件的自动加载</a></li><li class="sidebar-sub-header"><a href="/blog/note/自动化构建.html#开发服务器" class="sidebar-link">开发服务器</a></li><li class="sidebar-sub-header"><a href="/blog/note/自动化构建.html#useref-文件引用处理" class="sidebar-link">useref 文件引用处理</a></li><li class="sidebar-sub-header"><a href="/blog/note/自动化构建.html#文件压缩" class="sidebar-link">文件压缩</a></li><li class="sidebar-sub-header"><a href="/blog/note/自动化构建.html#重新规划构建过程" class="sidebar-link">重新规划构建过程</a></li><li class="sidebar-sub-header"><a href="/blog/note/自动化构建.html#项目配置scripts脚本" class="sidebar-link">项目配置scripts脚本</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/note/自动化构建.html#封装工作流" class="sidebar-link">封装工作流</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/note/自动化构建.html#提取-gulpfile-文件" class="sidebar-link">提取 Gulpfile 文件</a></li><li class="sidebar-sub-header"><a href="/blog/note/自动化构建.html#提取配置文件" class="sidebar-link">提取配置文件</a></li><li class="sidebar-sub-header"><a href="/blog/note/自动化构建.html#抽象路径配置" class="sidebar-link">抽象路径配置</a></li><li class="sidebar-sub-header"><a href="/blog/note/自动化构建.html#包装-gulp-cli" class="sidebar-link">包装 Gulp Cli</a></li><li class="sidebar-sub-header"><a href="/blog/note/自动化构建.html#发布" class="sidebar-link">发布</a></li></ul></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>一切重复工作本应自动化</p> <img src="/blog/img/auto.png" alt="queue" class="custom"> <p>自动化构建就是将源代码自动转换成生产上可用的代码，这个过程叫做<strong>自动化工作流</strong></p> <p>作用</p> <ul><li>脱离运行环境兼容带来的问题</li> <li>使用提高效率的语法、规范和标准</li></ul> <h2 id="常用自动化构建工具"><a href="#常用自动化构建工具" class="header-anchor">#</a> 常用自动化构建工具</h2> <ul><li><p>Grunt</p> <blockquote><p>最早的构建系统，官方介绍说可以几乎完成任何事情，但是是基于临时文件的，所以构建速度相对较慢</p></blockquote></li> <li><p>Gulp</p> <blockquote><p>它是基于内存实现的，所以解决了构建速度的问题，默认支持同时执行多个任务，效率大大提高，可以说是市面上最流行的前端构建系统</p></blockquote></li> <li><p>FIS</p> <blockquote><p>百度的前端团队推出的一款构建工具，它尽可能的把我们的需求都集成在了内部，是一款大而全的构建工具</p></blockquote></li></ul> <p>严格来说，webpack 是一个模块打包工具，所以不在里面</p> <h2 id="grunt"><a href="#grunt" class="header-anchor">#</a> Grunt</h2> <h3 id="基本使用"><a href="#基本使用" class="header-anchor">#</a> 基本使用</h3> <p>创建一个空的项目，然后初始化<code>package.json</code>文件，安装 <code>grunt</code>模块</p> <p><code>mkdir grunt-sample</code></p> <p><code>yarn init -y</code></p> <p><code>yarn add grunt</code></p> <p>创建 Grunt 的入口文件 gruntfile.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Grunt 的入口文件</span>
<span class="token comment">// 用于定义一些需要 Grunt执行的任务</span>
<span class="token comment">// 需要导出一个函数</span>
<span class="token comment">// 此函数接收一个 grunt 的形参，内部提供一些创建任务时可以用到的 API</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">grunt</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  grunt<span class="token punctuation">.</span><span class="token function">registerTask</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hello grunt~'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  grunt<span class="token punctuation">.</span><span class="token function">registerTask</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token string">'任务描述'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'other task~'</span><span class="token punctuation">)</span>
    
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>registerTask</code>第二参数是任务的描述信息，可以通过<code>yarn grunt --help</code>查看任务的描述信息</p> <img src="/blog/img/gruntTaskDesc.png" alt="queue" class="custom"> <p>然后我们可以通过<code>yarn grunt 任务名称</code>的方式去执行我们的任务</p> <img src="/blog/img/grunt1.png" alt="queue" class="custom"> <p>如果我们在注册任务时，任务名称是<code>default</code>那么这个任务会成为<code>grunt</code>的默认任务，执行的时候不需要添加任务名称，<code>yarn grunt</code>就可以了</p> <p>一般来说我们在注册<code>default</code>任务的时候第二个参数会传入一个数组，然后里面填写我们需要执行的任务名称，<code>grunt</code>就会依次执行我们的任务</p> <img src="/blog/img/gruntdefault.png" alt="queue" class="custom"> <h3 id="异步任务"><a href="#异步任务" class="header-anchor">#</a> 异步任务</h3> <p>我们尝试注册一个异步任务</p> <div class="language-js extra-class"><pre class="language-js"><code>grunt<span class="token punctuation">.</span><span class="token function">registerTask</span><span class="token punctuation">(</span><span class="token string">'async-task'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async task workding~'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>然后在命令行中去执行这个任务</p> <p><code>yarn grunt async-task</code></p> <img src="/blog/img/gruntasync.png" alt="queue" class="custom"> <p>发现命令行中没有打印</p> <p>这个是grunt的一个特点，它默认支持同步模式，如果要使用异步模式的话，我们需要使用它里面this.async()方法</p> <div class="language-js extra-class"><pre class="language-js"><code>grunt<span class="token punctuation">.</span><span class="token function">registerTask</span><span class="token punctuation">(</span><span class="token string">'async-task'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> done <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async task workding~'</span><span class="token punctuation">)</span>
        <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>我们使用this.async拿到一个方法，然后用它来表示任务结束</p> <p>注意：使用this的话就不能使用箭头函数</p> <p>然后我们在去执行我们的任务，就会发现正常打印了</p> <img src="/blog/img/gruntaysnc1.png" alt="queue" class="custom"> <h3 id="grunt标记任务失败"><a href="#grunt标记任务失败" class="header-anchor">#</a> Grunt标记任务失败</h3> <p>当我们在执行任务时，如果发生错误，比如说文件找不到，这个时候我们可以将这个任务标记为失败任务</p> <p>我们可以在任务的函数体中<code>return false</code>来标记这个任务的失败，如果该任务是在任务列表中，那么会导致后续的任务都不会被执行</p> <div class="language-js extra-class"><pre class="language-js"><code>grunt<span class="token punctuation">.</span><span class="token function">registerTask</span><span class="token punctuation">(</span><span class="token string">'bad'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'bad workding~'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>如果我们采用<code>yarn grunt --force</code>，那么会强制执行所有的任务</p> <img src="/blog/img/gruntbad.png" alt="queue" class="custom"> <p>如果是一个异步任务，那么需要通过done(false)的方式</p> <div class="language-js extra-class"><pre class="language-js"><code>grunt<span class="token punctuation">.</span><span class="token function">registerTask</span><span class="token punctuation">(</span><span class="token string">'bad-async'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> done <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async task workding~'</span><span class="token punctuation">)</span>
        <span class="token function">done</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>然后我们执行<code>yarn grunt bad-async</code>，得到的结果也是失败的</p> <h3 id="grunt-的配置方法"><a href="#grunt-的配置方法" class="header-anchor">#</a> Grunt 的配置方法</h3> <p>Grunt 中提供了一个initConfig的配置方法</p> <div class="language-js extra-class"><pre class="language-js"><code>grunt<span class="token punctuation">.</span><span class="token function">initConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    hello<span class="token operator">:</span> <span class="token string">'world'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
grunt<span class="token punctuation">.</span><span class="token function">registerTask</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>grunt<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>其中健就是任务名称</p> <p>然后我们去执行以下这个任务</p> <p><code>yarn grunt hello</code></p> <img src="/blog/img/gruntconfig.png" alt="queue" class="custom"> <p>可以看到成功的打印出了world</p> <h3 id="grunt-多目标任务"><a href="#grunt-多目标任务" class="header-anchor">#</a> Grunt 多目标任务</h3> <p>多目标任务，可以让任务根据配置形成多个子任务</p> <p>需要通过<code>registerMultiTask</code>方法</p> <div class="language-js extra-class"><pre class="language-js"><code>grunt<span class="token punctuation">.</span><span class="token function">registerMultiTask</span><span class="token punctuation">(</span><span class="token string">'build'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'build task'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这个时候我们去执行这个任务他会报错，告诉我们需要配置目标，我们需要通过<code>initConfig</code>来配置</p> <div class="language-js extra-class"><pre class="language-js"><code>grunt<span class="token punctuation">.</span><span class="token function">initConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    build<span class="token operator">:</span> <span class="token punctuation">{</span>
        css<span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
        js<span class="token operator">:</span> <span class="token string">'2'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>config中的健需要是我们的任务名称，然后值是一个对象</p> <img src="/blog/img/mutilTask.png" alt="queue" class="custom"> <p>它会执行我们配置的所有目标，如果需要执行其中的某一个目标，可以通过<code>yarn grunt build:css</code>的方式去执行</p> <p>在任务中，我们可以通过<code>this.target</code>拿到任务名称，<code>this.data</code>拿到任务数据</p> <div class="language-js extra-class"><pre class="language-js"><code>grunt<span class="token punctuation">.</span><span class="token function">registerMultiTask</span><span class="token punctuation">(</span><span class="token string">'build'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">target: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>target<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, data: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><img src="/blog/img/taskName.png" alt="queue" class="custom"> <p>在config中配置的除了options的其他所有健都会被当做任务执行</p> <p>options会当做配置选项出现，在任务函数体中可以通过<code>this.options()</code>拿到我们的配置选项</p> <div class="language-js extra-class"><pre class="language-js"><code>grunt<span class="token punctuation">.</span><span class="token function">initConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    build<span class="token operator">:</span> <span class="token punctuation">{</span>
        options<span class="token operator">:</span> <span class="token punctuation">{</span>
            foo<span class="token operator">:</span> <span class="token string">'bar'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        css<span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
        js<span class="token operator">:</span> <span class="token string">'2'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
grunt<span class="token punctuation">.</span><span class="token function">registerMultiTask</span><span class="token punctuation">(</span><span class="token string">'build'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">options</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">target: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>target<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, data: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>执行后就会看到我们的配置选项</p> <img src="/blog/img/gruntoptions.png" alt="queue" class="custom"> <p>我们也可以在目标中配置选项</p> <div class="language-js extra-class"><pre class="language-js"><code> grunt<span class="token punctuation">.</span><span class="token function">initConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
     build<span class="token operator">:</span> <span class="token punctuation">{</span>
         options<span class="token operator">:</span> <span class="token punctuation">{</span>
             foo<span class="token operator">:</span> <span class="token string">'bar'</span>
         <span class="token punctuation">}</span><span class="token punctuation">,</span>
         css<span class="token operator">:</span> <span class="token punctuation">{</span>
             options<span class="token operator">:</span> <span class="token punctuation">{</span>
                 foo<span class="token operator">:</span> <span class="token string">'bar'</span>
             <span class="token punctuation">}</span>
         <span class="token punctuation">}</span><span class="token punctuation">,</span>
         js<span class="token operator">:</span> <span class="token string">'2'</span>
     <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>目标中配置的 options 会覆盖掉之前配置的 options</p> <img src="/blog/img/optionsOver.png" alt="queue" class="custom"> <h3 id="grunt-插件的使用"><a href="#grunt-插件的使用" class="header-anchor">#</a> Grunt 插件的使用</h3> <p>grunt 插件的命名规则是 <code>grunt-contrib-&lt;taskname&gt;</code></p> <p>我们这里来举个例子，我们安装一个<code>grunt-contrib-clean</code>的插件，它的作用是清除项目中的临时文件</p> <p>我们在这里新建一个 temp 目录，然后下面新建 app.js、foo.txt、bar.txt和index.html文件用来演示</p> <p>这个任务是一个多目标任务，所以我们需要配置通过initConfig来配置目标</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">grunt</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  grunt<span class="token punctuation">.</span><span class="token function">initConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    clean<span class="token operator">:</span> <span class="token punctuation">{</span>
      temp<span class="token operator">:</span> <span class="token string">'temp/app.js'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  grunt<span class="token punctuation">.</span><span class="token function">loadNpmTasks</span><span class="token punctuation">(</span><span class="token string">'grunt-contrib-clean'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后我们去执行我们的任务<code>yarn grunt clean</code></p> <p>就会发现temp目录下的app.js被清除了</p> <p>它也支持通配符的方式配置</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">grunt</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  grunt<span class="token punctuation">.</span><span class="token function">initConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    clean<span class="token operator">:</span> <span class="token punctuation">{</span>
      temp<span class="token operator">:</span> <span class="token string">'temp/*.txt'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  grunt<span class="token punctuation">.</span><span class="token function">loadNpmTasks</span><span class="token punctuation">(</span><span class="token string">'grunt-contrib-clean'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后我们去执行我们的任务<code>yarn grunt clean</code></p> <p>就会发现temp目录下的txt文件被清除了</p> <p>还有一种删除目录下所有文件的配置</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">grunt</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  grunt<span class="token punctuation">.</span><span class="token function">initConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    clean<span class="token operator">:</span> <span class="token punctuation">{</span>
      temp<span class="token operator">:</span> <span class="token string">'temp/**'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  grunt<span class="token punctuation">.</span><span class="token function">loadNpmTasks</span><span class="token punctuation">(</span><span class="token string">'grunt-contrib-clean'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后我们去执行我们的任务<code>yarn grunt clean</code></p> <p>就会发现temp目录及它下面的所有文件都被删除了</p> <h3 id="grunt-常用插件"><a href="#grunt-常用插件" class="header-anchor">#</a> Grunt 常用插件</h3> <h4 id="grunt-sass"><a href="#grunt-sass" class="header-anchor">#</a> grunt-sass</h4> <p>这个模块需要一个sass模块的支持，我们先来安装这个模块</p> <p><code>yarn add grunt-sass sass --dev</code></p> <p>然后我们准备了一个main.scss文件，放在src下面的scss目录</p> <p>接下来我们就可以去书写gruntfile.js文件了</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> sass <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sass'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">grunt</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

  grunt<span class="token punctuation">.</span><span class="token function">initConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    sass<span class="token operator">:</span> <span class="token punctuation">{</span>
      options<span class="token operator">:</span> <span class="token punctuation">{</span>
         <span class="token comment">// 意思是用那个模块去解析我们的代码</span>
        implementation<span class="token operator">:</span> sass
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      main<span class="token operator">:</span> <span class="token punctuation">{</span>
        files<span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token comment">// 健是输出路径 值是需要编译的路径也就是源代码路径</span>
          <span class="token string">'dist/css/main.css'</span><span class="token operator">:</span> <span class="token string">'src/scss/main.scss'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  grunt<span class="token punctuation">.</span><span class="token function">loadNpmTasks</span><span class="token punctuation">(</span><span class="token string">'grunt-sass'</span><span class="token punctuation">)</span>
  
<span class="token punctuation">}</span>
</code></pre></div><p>执行我们的任务<code>yarn grunt sass</code></p> <p>就可以看到在根目录下面多了一个dist目录，下面是我们被编译后的样式文件</p> <p>还可以在options中配置其它的选项，例如</p> <div class="language-js extra-class"><pre class="language-js"><code>sourceMap<span class="token operator">:</span> <span class="token boolean">true</span>
</code></pre></div><p>然后它就会自动帮我们生成soureMap文件</p> <h4 id="grunt-babel"><a href="#grunt-babel" class="header-anchor">#</a> grunt-babel</h4> <p>还有我们在开发过程中经常需要去编译ES6 的文件，使用的最多就是babel，我们也可以去安装<code>grunt-babel</code>插件</p> <p><code>grunt-babel</code>它也是需要<code>babel</code>的核心模块作为支持的</p> <p><code>yarn add grunt-babel @babel/core @babel/preset-env --dev</code></p> <p>这样我们需要载入这个模块，但是随着开发过程中需要载入的伊利越来越多，那么我们的文件就会越来越复杂，我们可以利用一个<code>load-grunt-tasks</code>的插件来帮助我们</p> <p><code>yarn add load-grunt-tasks -D</code></p> <p>有了这个工具后我们就可以使用它去加载所有的 grunt 插件了</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> sass <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sass'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> loadGruntTasks <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'load-grunt-tasks'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">grunt</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  grunt<span class="token punctuation">.</span><span class="token function">initConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    sass<span class="token operator">:</span> <span class="token punctuation">{</span>
      options<span class="token operator">:</span> <span class="token punctuation">{</span>
        sourceMap<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        implementation<span class="token operator">:</span> sass
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      main<span class="token operator">:</span> <span class="token punctuation">{</span>
        files<span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token comment">// 健是输出路径 值是需要编译的路径也就是源代码路径</span>
          <span class="token string">'dist/css/main.css'</span><span class="token operator">:</span> <span class="token string">'src/scss/main.scss'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// grunt.loadNpmTasks('grunt-sass')</span>
  <span class="token function">loadGruntTasks</span><span class="token punctuation">(</span>grunt<span class="token punctuation">)</span> <span class="token comment">// 自动加载所有的 grunt 插件中任务</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们接下来配置 babel 的目标</p> <div class="language-js extra-class"><pre class="language-js"><code>babel<span class="token operator">:</span> <span class="token punctuation">{</span>
    options<span class="token operator">:</span> <span class="token punctuation">{</span>
        sourceMap<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    main<span class="token operator">:</span> <span class="token punctuation">{</span>
        files<span class="token operator">:</span> <span class="token punctuation">{</span>
           <span class="token string">'dist/js/app.js'</span><span class="token operator">:</span> <span class="token string">'src/js/app.js'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后执行我们的任务<code>yarn grunt babel</code>，就可以看到在dist目录下被编译后的app.js</p> <h4 id="grunt-contrib-watch"><a href="#grunt-contrib-watch" class="header-anchor">#</a> grunt-contrib-watch</h4> <p>当文件被修改后自动编译</p> <p><code>yarn add grunt-contrib-watch -D</code></p> <p>然后我们可以去给这个任务添加一个目标配置</p> <div class="language-js extra-class"><pre class="language-js"><code>watch<span class="token operator">:</span> <span class="token punctuation">{</span>
    js<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 需要监视的文件路径</span>
        files<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'src/js/*.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token comment">// 需要执行的任务</span>
        tasks<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'babel'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    css<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token operator">/</span><span class="token operator">/</span> 需要监视的文件路径
        files<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'src/scss/*.scss'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token comment">// 需要执行的任务</span>
        tasks<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'sass'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后去执行watch任务，当我们去修改文件时，就会看到对应的任务被执行了</p> <p>我们可以看到他不会一开始就执行sass和babel任务，但是我们一般来说是需要任务先执行一次的， 所以我们可以添加一个defaut任务</p> <div class="language-js extra-class"><pre class="language-js"><code>grunt<span class="token punctuation">.</span><span class="token function">registerTask</span><span class="token punctuation">(</span><span class="token string">'default'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'sass'</span><span class="token punctuation">,</span> <span class="token string">'babel'</span><span class="token punctuation">,</span> <span class="token string">'watch'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>这样就可以满足我们的需求了</p> <img src="/blog/img/gruntplugins.png" alt="queue" class="custom"> <h2 id="gulp"><a href="#gulp" class="header-anchor">#</a> Gulp</h2> <p>Gulp 中所有的任务都是异步任务</p> <h3 id="基本使用-2"><a href="#基本使用-2" class="header-anchor">#</a> 基本使用</h3> <p>创建一个目录并进入</p> <p><code>mkdir gulp-start</code></p> <p><code>cd gulp-start</code></p> <p>初始化 package.json</p> <p><code>yarn init -y</code></p> <p>安装 gulp 作为开发依赖</p> <p><code>yarn add gulp --dev</code></p> <p>创建入口文件 gulpfile.js</p> <p><code>touch gulpfile.js</code></p> <p>创建一个任务</p> <div class="language-js extra-class"><pre class="language-js"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token parameter">done</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'task working~'</span><span class="token punctuation">)</span>
  <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在控制台执行这个任务</p> <p><code>yarn gulp foo</code></p> <p>gulp 中规定每一个任务都是异步任务，我们需要通过 done 来告知 gulp 任务完成了，如果不告知它任务完成，他就会报错</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 会报错</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token parameter">done</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'task working~'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><img src="/blog/img/gulpStart.png" alt="queue" class="custom"> <p>如果任务名称是 default 的话，它会作为 gulp 的默认任务，我们在执行的时候就可以不用写任务名称， <code>yarn gulp</code>这样就可以了</p> <h3 id="组合任务"><a href="#组合任务" class="header-anchor">#</a> 组合任务</h3> <p>gulp 模块提供了series 合 parallel 两个组合任务 API</p> <p>series 会按照顺序依次执行任务</p> <p>parallel 会并行的执行所有的任务</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> series<span class="token punctuation">,</span> parallel <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token parameter">done</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'foo task'</span><span class="token punctuation">)</span>
  <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">bar</span> <span class="token operator">=</span> <span class="token parameter">done</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'bar task'</span><span class="token punctuation">)</span>
  <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
exports<span class="token punctuation">.</span>sTask <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>foo<span class="token punctuation">,</span> bar<span class="token punctuation">)</span>
exports<span class="token punctuation">.</span>pTask <span class="token operator">=</span> <span class="token function">parallel</span><span class="token punctuation">(</span>foo<span class="token punctuation">,</span> bar<span class="token punctuation">)</span>
</code></pre></div><p>可以看下运行结果</p> <img src="/blog/img/composeTask.png" alt="queue" class="custom"> <h3 id="异步任务-2"><a href="#异步任务-2" class="header-anchor">#</a> 异步任务</h3> <h4 id="回调函数的放式"><a href="#回调函数的放式" class="header-anchor">#</a> 回调函数的放式</h4> <div class="language-js extra-class"><pre class="language-js"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">callback</span> <span class="token operator">=</span> <span class="token parameter">done</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'callback done'</span><span class="token punctuation">)</span>
  <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果想抛出一个错误，可以给回调函数指定一个错误对象</p> <div class="language-js extra-class"><pre class="language-js"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">callback</span> <span class="token operator">=</span> <span class="token parameter">done</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'callback done'</span><span class="token punctuation">)</span>
  <span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="promise"><a href="#promise" class="header-anchor">#</a> Promise</h4> <p>gulp中也可以使用 Promise 来处理异步任务</p> <div class="language-js extra-class"><pre class="language-js"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">promise</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise task'</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>失败的情况可以使用 Promise.reject</p> <div class="language-js extra-class"><pre class="language-js"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">promise</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise task'</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'task failed'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>也可以通过 async-await 的放式</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">timeout</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> time<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">async</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">timeout</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'task run'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="stream"><a href="#stream" class="header-anchor">#</a> stream</h4> <p>需要在任务处理函数中返回一个stream对象</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">stream</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> readStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'package.json'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> writeStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">'temp.txt'</span><span class="token punctuation">)</span>
  <span class="token comment">// 文件复制</span>
  readStream<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>writeStream<span class="token punctuation">)</span>
    <span class="token comment">// 返回stream</span>
  <span class="token keyword">return</span> readStream
<span class="token punctuation">}</span>
</code></pre></div><p>我们执行这个任务发现它是可以正常执行，正常结束，它结束的时机其实就是 readStream 的 end 的时候，可以通过下面的伪代码来实现一下</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">stream</span> <span class="token operator">=</span> <span class="token parameter">done</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> readStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'package.json'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> writeStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">'temp.txt'</span><span class="token punctuation">)</span>
  readStream<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>writeStream<span class="token punctuation">)</span>
  readStream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="gulp-构建过程核心工作原理"><a href="#gulp-构建过程核心工作原理" class="header-anchor">#</a> Gulp 构建过程核心工作原理</h3> <p>工作的过程可以用下面这张图来表示</p> <img src="/blog/img/gulpwork.png" alt="queue" class="custom"> <p>接下来我们来实现css的压缩这个功能</p> <p>首先我们来实现文件的复制这个功能</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">default</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 文件读取流</span>
  <span class="token keyword">const</span> read <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'nomalize.css'</span><span class="token punctuation">)</span>
  <span class="token comment">// 文件写入流</span>
  <span class="token keyword">const</span> write <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">'nomalize.min.css'</span><span class="token punctuation">)</span>
  <span class="token comment">// 把读取出来的文件流导入写入流</span>
  read<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>write<span class="token punctuation">)</span>
  <span class="token keyword">return</span> read
<span class="token punctuation">}</span>
</code></pre></div><p>然后再实现压缩的功能，这个时候我们需要用到 stream 中的 Transform 模块</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Transform <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'stream'</span><span class="token punctuation">)</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">default</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 文件读取流</span>
  <span class="token keyword">const</span> read <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'nomalize.css'</span><span class="token punctuation">)</span>
  <span class="token comment">// 文件写入流</span>
  <span class="token keyword">const</span> write <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">'nomalize.min.css'</span><span class="token punctuation">)</span>
  <span class="token comment">// 文件转换流</span>
  <span class="token keyword">const</span> transform <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transform</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">transform</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 核心转换过程</span>
      <span class="token comment">// chunk =&gt; 读取流中读取到的内容（Buffer）</span>
      <span class="token comment">// 因为它是一个字节数组，我们toString一下变成一个字符串</span>
      <span class="token keyword">const</span> input <span class="token operator">=</span> chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// 把内中的空白字符合注释去掉</span>
      <span class="token keyword">const</span> output <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\s+/g</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\/\*.+?\*\//g</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
      <span class="token comment">// 错误优先原则，第一个参数是错误，没有错误传递一个 null</span>
      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> output<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 把读取出来的文件流导入写入流</span>
  read
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>transform<span class="token punctuation">)</span> <span class="token comment">// 转换</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>write<span class="token punctuation">)</span> <span class="token comment">// 写入</span>
  <span class="token keyword">return</span> read
<span class="token punctuation">}</span>
</code></pre></div><p>然后我们再执行任务，就会发现我们的css代码正常被压缩了</p> <h3 id="gulp-文件操作-api-插件的使用"><a href="#gulp-文件操作-api-插件的使用" class="header-anchor">#</a> Gulp 文件操作 API + 插件的使用</h3> <p>gulp 提供了 src 文件读取流和 dest 写入流两个API</p> <p>接下来我们就使用这两个API来实现文件的复制</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">default</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/nomalize.css'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后我们执行任务后就可以看到dist目录以及下面的css文件，说明我们的读取流和写入流都可以正常工作</p> <p>gulp提供的AIPI功能会更加强大一些，我们可以使用通配符的方式</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">default</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/*.css'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样src目录下所有的css文件都会被复制到dist目录下</p> <p>构建的过程最重要的就是文件的转换，这里我们去安装一个<code>gulp-clean-css</code>，它提供了css的压缩转换流</p> <p><code>yarn add gulp-clean-css -D</code></p> <p>然后我们再pipe到dist目录之前先pipe到这个转换流中</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> cleanCss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-clean-css'</span><span class="token punctuation">)</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">default</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/*.css'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">cleanCss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>执行任务后，可以在dist中看到被压缩后的css代码了，如果需要做其他的转换，可以在中间继续pipe</p> <p>例如我们这里安装一个 <code>gulp-rename</code>的插件</p> <p><code>yarn add gulp-rename -D</code></p> <p>然后去引入并使用它</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> cleanCss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-clean-css'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> rename <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-rename'</span><span class="token punctuation">)</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">default</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/*.css'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">cleanCss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// extname =&gt; 重命名后的扩展名</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">rename</span><span class="token punctuation">(</span><span class="token punctuation">{</span>extname<span class="token operator">:</span> <span class="token string">'.min.css'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以上这样的一个任务执行过程就是常规过程</p> <h3 id="gulp-自动化构建案例"><a href="#gulp-自动化构建案例" class="header-anchor">#</a> Gulp 自动化构建案例</h3> <h4 id="样式编译"><a href="#样式编译" class="header-anchor">#</a> 样式编译</h4> <p>首先我们准备好一个基本的项目用来演示我们的案例，下面是项目的基本目录解构</p> <img src="/blog/img/demo1.png" alt="queue" class="custom"> <p>首先我们安装一下 gulp</p> <p><code>yarn add gulp --dev</code></p> <p>然后创建一个入口文件 gulpfile.js 来定义我们的任务</p> <p><code>touch gulpfile.js</code></p> <p>我们首先来定义个 style 的任务，用来编译我们的样式文件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">style</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/styles/*.scss'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  style
<span class="token punctuation">}</span>
</code></pre></div><p>执行任务后我们会发现它会丢失原来的目录结构，但是我们是希望保留的，所以可以给 src 配置一个 base 的参数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">style</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/styles/*.scss'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>base<span class="token operator">:</span> <span class="token string">'src'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  style
<span class="token punctuation">}</span>
</code></pre></div><p>这样文件复制的功能就写好了，接下来就是样式的转换了，我们需要去安装一个 gulp-sass 的插件</p> <p><code>yarn add gulp-sass --dev</code></p> <p>然后去使用它</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> sass <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-sass'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">style</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/styles/*.scss'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">sass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  style
<span class="token punctuation">}</span>
</code></pre></div><p>这样我们的样式文件就会被转换了，但是转换完成之后样式结尾的括号在最后一个分号 的后面，我们一般是希望它另起一行，所以，我们可以给 sass 配置一下</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">sass</span><span class="token punctuation">(</span><span class="token punctuation">{</span>outputStyle<span class="token operator">:</span> <span class="token string">'expanded'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>然后执行我们的任务，就可以看到被编译后的样式文件了，还有一个注意点是以下划线开头的文件在 sass 工作中认为他们都是文件中被依赖的文件，会被忽略掉不会被转换</p> <h4 id="脚本编译"><a href="#脚本编译" class="header-anchor">#</a> 脚本编译</h4> <p>先定义一个 script 的任务</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">script</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/scripts/*.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  style<span class="token punctuation">,</span>
  script
<span class="token punctuation">}</span>
</code></pre></div><p>然后我们编译脚本需要用到 babel ，我们去安装一下</p> <p><code>yarn add gulp-babel @babel/core @babel/preset-env --dev</code></p> <p>然后去引入并使用它</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-babel'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">script</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/scripts/*.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">babel</span><span class="token punctuation">(</span><span class="token punctuation">{</span>presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>这样我们这个功能就完成了</p> <h4 id="页面编译"><a href="#页面编译" class="header-anchor">#</a> 页面编译</h4> <p>页面编译我们需要用到 <code>gulp-swig</code>这个插件，我们先去安装</p> <p><code>yarn add gulp-swig --dev</code></p> <p>然后引入使用</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> swig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-swig'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">page</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/*.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">swig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>因为我们的页面采用了模板语法</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>jumbotron-heading<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{ pkg.name | upper }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>我们需要传入对应的数据，这里准备好了一个数据</p> <div class="language-json extra-class"><pre class="language-json"><code>const data = <span class="token punctuation">{</span>
  menus<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> 'Home'<span class="token punctuation">,</span>
      icon<span class="token operator">:</span> 'aperture'<span class="token punctuation">,</span>
      link<span class="token operator">:</span> 'index.html'
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> 'Features'<span class="token punctuation">,</span>
      link<span class="token operator">:</span> 'features.html'
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> 'About'<span class="token punctuation">,</span>
      link<span class="token operator">:</span> 'about.html'
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> 'Contact'<span class="token punctuation">,</span>
      link<span class="token operator">:</span> '#'<span class="token punctuation">,</span>
      children<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> 'Twitter'<span class="token punctuation">,</span>
          link<span class="token operator">:</span> 'https<span class="token operator">:</span><span class="token comment">//twitter.com/w_zce'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> 'About'<span class="token punctuation">,</span>
          link<span class="token operator">:</span> 'https<span class="token operator">:</span><span class="token comment">//weibo.com/zceme'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> 'divider'
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> 'About'<span class="token punctuation">,</span>
          link<span class="token operator">:</span> 'https<span class="token operator">:</span><span class="token comment">//github.com/zce'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  pkg<span class="token operator">:</span> require('./package.json')<span class="token punctuation">,</span>
  date<span class="token operator">:</span> new Date()
<span class="token punctuation">}</span>
</code></pre></div><p>然后再使用 swig 的时候传入就可以了</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">swig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这样我们的页面编译功能就完成了</p> <p>因为样式编译，脚本编译，页面编译这三个功能总是组合在一起使用，所以我们可以使用 gulp 的组合任务API将他们组合在一起，因为他们之间没有什么关联，所以使用并行组合 parallel</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> compile <span class="token operator">=</span> <span class="token function">parallel</span><span class="token punctuation">(</span>style<span class="token punctuation">,</span> script<span class="token punctuation">,</span> page<span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  compile
<span class="token punctuation">}</span>
</code></pre></div><h3 id="图标和字体文件转换"><a href="#图标和字体文件转换" class="header-anchor">#</a> 图标和字体文件转换</h3> <p>图标和字体文件需要借助一个 <code>gulp-imagemin</code>的插件</p> <p><code>yarn add gulp-imagemin --dev</code></p> <p>然后我们去定义两个任务，image 和 font</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> imagemin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-imagemin'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">image</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/images/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">font</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/fonts/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后放在组合任务中</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> compile <span class="token operator">=</span> <span class="token function">parallel</span><span class="token punctuation">(</span>style<span class="token punctuation">,</span> script<span class="token punctuation">,</span> page<span class="token punctuation">,</span> image<span class="token punctuation">,</span> font<span class="token punctuation">)</span>
</code></pre></div><p>这样我们的图标和字体文件都会被转换掉了</p> <h3 id="其他文件的拷贝和文件的清除"><a href="#其他文件的拷贝和文件的清除" class="header-anchor">#</a> 其他文件的拷贝和文件的清除</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">extra</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'public/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'public'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们认为 compile 只是编译 src 文件夹下面的文件</p> <p>所以我们单独定义一个组合任务将 compile 和 extra 组合起来</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> build <span class="token operator">=</span> <span class="token function">parallel</span><span class="token punctuation">(</span>compile<span class="token punctuation">,</span> extra<span class="token punctuation">)</span>
</code></pre></div><p>文件清除我们需要借助一个 del 的插件</p> <p><code>yarn add del --dev</code></p> <p>然后我们去引入并使用它</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">clean</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'dist'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>它需要传递一个数组，中间是我们需要清除的文件夹名称，这里是 dist， 清除任务应该再编译任务之前，并且编译任务需要等待清除任务完成之后才能执行，所以这里我们使用 series 将清除任务和编译任务组合起来</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> build <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>clean<span class="token punctuation">,</span> <span class="token function">parallel</span><span class="token punctuation">(</span>compile<span class="token punctuation">,</span> extra<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>然后我们去执行 build 任务</p> <img src="/blog/img/build.png" alt="queue" class="custom"> <p>可以看到任务的执行过程是符号我们的预期的</p> <h3 id="插件的自动加载"><a href="#插件的自动加载" class="header-anchor">#</a> 插件的自动加载</h3> <p>随着任务越来越复杂，那么需要导入的插件就会越来越多，我们可以通过一个 <code>gulp-load-plugins</code>这个插件来自动加载所有的插件</p> <p><code>yarn add gulp-load-plugins --dev</code></p> <p>这个插件加载后，所有的任务都会变成它的一个属性，需要通过 <code>plugins.插件</code>的方式</p> <p>然后我们对之前的任务做一下修改</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> parallel<span class="token punctuation">,</span> series <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> del <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'del'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> loadPlugins <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-load-plugins'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> plugins <span class="token operator">=</span> <span class="token function">loadPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
  menus<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Home'</span><span class="token punctuation">,</span>
      icon<span class="token operator">:</span> <span class="token string">'aperture'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'index.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Features'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'features.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'About'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'about.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Contact'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'#'</span><span class="token punctuation">,</span>
      children<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'Twitter'</span><span class="token punctuation">,</span>
          link<span class="token operator">:</span> <span class="token string">'https://twitter.com/w_zce'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'About'</span><span class="token punctuation">,</span>
          link<span class="token operator">:</span> <span class="token string">'https://weibo.com/zceme'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'divider'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'About'</span><span class="token punctuation">,</span>
          link<span class="token operator">:</span> <span class="token string">'https://github.com/zce'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  pkg<span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./package.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  date<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">clean</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'dist'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">style</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/styles/*.scss'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">sass</span><span class="token punctuation">(</span><span class="token punctuation">{</span>outputStyle<span class="token operator">:</span> <span class="token string">'expanded'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">script</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/scripts/*.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">babel</span><span class="token punctuation">(</span><span class="token punctuation">{</span>presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">page</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/*.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">swig</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">image</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/images/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">font</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/fonts/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">extra</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'public/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'public'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> compile <span class="token operator">=</span> <span class="token function">parallel</span><span class="token punctuation">(</span>style<span class="token punctuation">,</span> script<span class="token punctuation">,</span> page<span class="token punctuation">,</span> image<span class="token punctuation">,</span> font<span class="token punctuation">)</span>

<span class="token keyword">const</span> build <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>clean<span class="token punctuation">,</span> <span class="token function">parallel</span><span class="token punctuation">(</span>compile<span class="token punctuation">,</span> extra<span class="token punctuation">)</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  build
<span class="token punctuation">}</span>
</code></pre></div><h3 id="开发服务器"><a href="#开发服务器" class="header-anchor">#</a> 开发服务器</h3> <p>在开发阶段需要调试我们的应用，所以我们需要一个开发服务器</p> <p>这里我们使用 <code>browser-sync</code>，先安装这个模块</p> <p><code>yarn add browser-sync --dev</code></p> <p>这个模块支持热更新，有一个非常良好的开发体验</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> browserSync <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'browser-sync'</span><span class="token punctuation">)</span>
<span class="token comment">// 通过它的 create 方法创建</span>
<span class="token keyword">const</span> bs <span class="token operator">=</span> browserSync<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 定义一个任务</span>
<span class="token keyword">const</span> <span class="token function-variable function">serve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  bs<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    server<span class="token operator">:</span> <span class="token punctuation">{</span>
      baseDir<span class="token operator">:</span> <span class="token string">'dist'</span> <span class="token comment">// 将哪个目录作为启动目录,这里是dist目录</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  serve
<span class="token punctuation">}</span>
</code></pre></div><p>然后执行 serve 任务就可以在浏览器中看到效果了，但是我们会发现样式不对，因为在页面中我们的样式是引入的node_modules下面的</p> <div class="language-html extra-class"><pre class="language-html"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/node_modules/bootstrap/dist/css/bootstrap.css<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>我们dist目录下面是没有这些样式的，我们可以在给browserSync去配置一个路由，这个路由的优先级是要高于baseDir的，他会先去这个路由里面寻找，找不到才会到baseDir下面去找</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">serve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  bs<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    server<span class="token operator">:</span> <span class="token punctuation">{</span>
      baseDir<span class="token operator">:</span> <span class="token string">'dist'</span><span class="token punctuation">,</span>
      routes<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">'/node_modules'</span><span class="token operator">:</span> <span class="token string">'node_modules'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后我们在执行这个任务就可以看到样式也正常了</p> <p>我们在页面启动的时候右上角会有一个提示，告诉我们browserSync是否连接上，这个有可能会影响到我们页面中的样式，所以我们可以关闭这个提示，还有一些其他的常用的小配置，端口和是否在启动打开 浏览器</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">serve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  bs<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    notify<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 关闭右上角的提示</span>
    port<span class="token operator">:</span> <span class="token number">2080</span><span class="token punctuation">,</span> <span class="token comment">// 端口</span>
    open<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 是否启动打开浏览器</span>
    server<span class="token operator">:</span> <span class="token punctuation">{</span>
      baseDir<span class="token operator">:</span> <span class="token string">'dist'</span><span class="token punctuation">,</span>
      routes<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">'/node_modules'</span><span class="token operator">:</span> <span class="token string">'node_modules'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后接下来我们来实现当我们代码修改后，页面自动会更新</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">serve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  bs<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    notify<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    port<span class="token operator">:</span> <span class="token number">2080</span><span class="token punctuation">,</span>
    open<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    files<span class="token operator">:</span> <span class="token string">'dist/**'</span><span class="token punctuation">,</span> <span class="token comment">// 当dist文件下的内容发生改变后，会自动更新到浏览器</span>
    server<span class="token operator">:</span> <span class="token punctuation">{</span>
      baseDir<span class="token operator">:</span> <span class="token string">'dist'</span><span class="token punctuation">,</span>
      routes<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">'/node_modules'</span><span class="token operator">:</span> <span class="token string">'node_modules'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>主要是配置一个files，这个时候我们只是修改编译后的代码会立即生效，源代码修改后并不会生效，我们只需要监视源代码的变化然后重新编译就可以了</p> <p>这个时候我们需要借助 gulp 的另外一个 API watch，它可以监视文件，然后决定是否要执行某一个任务</p> <p>我们先引入 watch</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> parallel<span class="token punctuation">,</span> series<span class="token punctuation">,</span> watch <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span>
</code></pre></div><p>然后在启动服务的时候去监视文件并指定任务</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">serve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/assets/styles/*.scss'</span><span class="token punctuation">,</span> style<span class="token punctuation">)</span>
  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/assets/scripts/*.js'</span><span class="token punctuation">,</span> script<span class="token punctuation">)</span>
  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/*.html'</span><span class="token punctuation">,</span> page<span class="token punctuation">)</span>
  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/assets/images/**'</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span>
  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/assets/fonts/**'</span><span class="token punctuation">,</span> font<span class="token punctuation">)</span>
  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'public/**'</span><span class="token punctuation">,</span> extra<span class="token punctuation">)</span>

  bs<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    notify<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    port<span class="token operator">:</span> <span class="token number">2080</span><span class="token punctuation">,</span>
    open<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    files<span class="token operator">:</span> <span class="token string">'dist/**'</span><span class="token punctuation">,</span>
    server<span class="token operator">:</span> <span class="token punctuation">{</span>
      baseDir<span class="token operator">:</span> <span class="token string">'dist'</span><span class="token punctuation">,</span>
      routes<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">'/node_modules'</span><span class="token operator">:</span> <span class="token string">'node_modules'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>现在有一个问题，图片字体这些文件我们在开发阶段其实是没有必要去监视的，因为他们是做的一个无损的压缩，我们也不会经常去修改他们，在开发阶段去监视更多的文件，开销也会更大</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">serve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/assets/styles/*.scss'</span><span class="token punctuation">,</span> style<span class="token punctuation">)</span>
  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/assets/scripts/*.js'</span><span class="token punctuation">,</span> script<span class="token punctuation">)</span>
  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/*.html'</span><span class="token punctuation">,</span> page<span class="token punctuation">)</span>
  <span class="token comment">// watch('src/assets/images/**', image)</span>
  <span class="token operator">/</span><span class="token operator">/</span> <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/assets/fonts/**'</span><span class="token punctuation">,</span> font<span class="token punctuation">)</span>
  <span class="token comment">// watch('public/**', extra)</span>
    
  bs<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    notify<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    port<span class="token operator">:</span> <span class="token number">2080</span><span class="token punctuation">,</span>
    open<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    files<span class="token operator">:</span> <span class="token string">'dist/**'</span><span class="token punctuation">,</span>
    server<span class="token operator">:</span> <span class="token punctuation">{</span>
      baseDir<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'dist'</span><span class="token punctuation">,</span> <span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'public'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      routes<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">'/node_modules'</span><span class="token operator">:</span> <span class="token string">'node_modules'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>


<span class="token keyword">const</span> compile <span class="token operator">=</span> <span class="token function">parallel</span><span class="token punctuation">(</span>style<span class="token punctuation">,</span> script<span class="token punctuation">,</span> page<span class="token punctuation">)</span>

<span class="token comment">// 上线之前执行的任务</span>
<span class="token keyword">const</span> build <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>clean<span class="token punctuation">,</span> <span class="token function">parallel</span><span class="token punctuation">(</span>compile<span class="token punctuation">,</span> image<span class="token punctuation">,</span> font<span class="token punctuation">,</span> extra<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> dev <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>compile<span class="token punctuation">,</span> serve<span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  clean<span class="token punctuation">,</span>
  build<span class="token punctuation">,</span>
  serve
<span class="token punctuation">}</span>
</code></pre></div><p>这里 baseDir 写成一个数组，执行的时候它会依次从数组中去查找需要的文件，现在 dist目录中找，找不到就会去 src 目录下查找，再找不到就会去 public 目录下找</p> <p>在执行serve任务之前需要先执行以下 compile 任务，这样就会确认dist目录存在，不会出错了</p> <p>当我们的图片字体更新后我们也希望可以更新以下浏览器，这个时候我们可以 watch 一个数组，然后去执行以下bs.reload就可以了</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token string">'src/assets/images/**'</span><span class="token punctuation">,</span>
    <span class="token string">'src/assets/fonts/**'</span><span class="token punctuation">,</span>
    <span class="token string">'public/**'</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span> bs<span class="token punctuation">.</span>reload<span class="token punctuation">)</span>
</code></pre></div><p>还有的时候我们可能看见不配置bs.init中的files选项也可以实现页面的热更新，其实这个也很简单，在任务的最后pipe bs.reload就可以了，然后传递一个 {stream: true},告知它以流的方式去传递</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">style</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/styles/*.scss'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">sass</span><span class="token punctuation">(</span><span class="token punctuation">{</span>outputStyle<span class="token operator">:</span> <span class="token string">'expanded'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span>stream<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">script</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/scripts/*.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">babel</span><span class="token punctuation">(</span><span class="token punctuation">{</span>presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">page</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/*.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">swig</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后就不要配置 files了</p> <div class="language-js extra-class"><pre class="language-js"><code>bs<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    notify<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    port<span class="token operator">:</span> <span class="token number">2080</span><span class="token punctuation">,</span>
    open<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// files: 'dist/**',</span>
    server<span class="token operator">:</span> <span class="token punctuation">{</span>
      baseDir<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'dist'</span><span class="token punctuation">,</span> <span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'public'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      routes<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">'/node_modules'</span><span class="token operator">:</span> <span class="token string">'node_modules'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="useref-文件引用处理"><a href="#useref-文件引用处理" class="header-anchor">#</a> useref 文件引用处理</h3> <p>useref会把构建注释中引入的文件全部合并到一个文件中</p> <p>首先安装一下</p> <p><code>yarn add useref --dev</code></p> <p>然后我们定义一个useref的任务</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">useref</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'dist/*.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'dist'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">useref</span><span class="token punctuation">(</span><span class="token punctuation">{</span> searchPath<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'dist'</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="文件压缩"><a href="#文件压缩" class="header-anchor">#</a> 文件压缩</h3> <p>我们在useref处理文件引用时生成的css和js文件我们希望可以压缩一下</p> <p>通过 useref 会产生 3 种文件 html js css</p> <p>针对不同的文件我们需要做不同的操作</p> <p>我们先安装处理不同文件类型的插件</p> <p><code>yarn add gulp-htmlmin gulp-uglify gulp-clean-css --dev</code></p> <p>我们还需要判断一下这个读取流中是什么类型的文件，还需要安装一个 gulp-if 的插件</p> <p><code>yarn add gulp -if</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">useref</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'dist/*.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'dist'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">useref</span><span class="token punctuation">(</span><span class="token punctuation">{</span> searchPath<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'dist'</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 通过 useref 会产生 3 种文件 html js css</span>
    <span class="token operator">/</span><span class="token operator">/</span> 针对不同的文件我们需要做不同的操作
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token regex">/\.js$/</span><span class="token punctuation">,</span> plugins<span class="token punctuation">.</span><span class="token function">uglify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token regex">/\.css$/</span><span class="token punctuation">,</span> plugins<span class="token punctuation">.</span><span class="token function">cleanCss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token regex">/\.html$/</span><span class="token punctuation">,</span> plugins<span class="token punctuation">.</span><span class="token function">htmlmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'release'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里还有一个问题，就是我们这里是从dist种读取，又写入到dist，这样就会产生一个读写的冲突，我们把写入的文件名修改一下就不会有这个问题了</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'release'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="重新规划构建过程"><a href="#重新规划构建过程" class="header-anchor">#</a> 重新规划构建过程</h3> <p>上面的任务写完后，我们的构建的目录结构就被打破了，所以我们需要重新规划一下</p> <p>我们将style,page,script任务产生的文件都放到temp目录下，因为他们只是一个临时文件，还需要经过useref后才能被放在生产上去使用，然后useref从temp目录下去读取文件并做处理，useref需要在compile之后执行，所以我们最终的构建流程代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> parallel<span class="token punctuation">,</span> series<span class="token punctuation">,</span> watch <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> del <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'del'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> browserSync <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'browser-sync'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> loadPlugins <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-load-plugins'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> plugins <span class="token operator">=</span> <span class="token function">loadPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> bs <span class="token operator">=</span> browserSync<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
  menus<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Home'</span><span class="token punctuation">,</span>
      icon<span class="token operator">:</span> <span class="token string">'aperture'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'index.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Features'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'features.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'About'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'about.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Contact'</span><span class="token punctuation">,</span>
      link<span class="token operator">:</span> <span class="token string">'#'</span><span class="token punctuation">,</span>
      children<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'Twitter'</span><span class="token punctuation">,</span>
          link<span class="token operator">:</span> <span class="token string">'https://twitter.com/w_zce'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'About'</span><span class="token punctuation">,</span>
          link<span class="token operator">:</span> <span class="token string">'https://weibo.com/zceme'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'divider'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'About'</span><span class="token punctuation">,</span>
          link<span class="token operator">:</span> <span class="token string">'https://github.com/zce'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  pkg<span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./package.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  date<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">clean</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'dist'</span><span class="token punctuation">,</span> <span class="token string">'temp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">style</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/styles/*.scss'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">sass</span><span class="token punctuation">(</span><span class="token punctuation">{</span>outputStyle<span class="token operator">:</span> <span class="token string">'expanded'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'temp'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span>stream<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">script</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/scripts/*.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">babel</span><span class="token punctuation">(</span><span class="token punctuation">{</span>presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'temp'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">page</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/*.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">swig</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'temp'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">image</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/images/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">font</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/fonts/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">extra</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'public/**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'public'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">serve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/assets/styles/*.scss'</span><span class="token punctuation">,</span> style<span class="token punctuation">)</span>
  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/assets/scripts/*.js'</span><span class="token punctuation">,</span> script<span class="token punctuation">)</span>
  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/*.html'</span><span class="token punctuation">,</span> page<span class="token punctuation">)</span>
  <span class="token comment">// watch('src/assets/images/**', image)</span>
  <span class="token operator">/</span><span class="token operator">/</span> <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/assets/fonts/**'</span><span class="token punctuation">,</span> font<span class="token punctuation">)</span>
  <span class="token comment">// watch('public/**', extra)</span>

  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token string">'src/assets/images/**'</span><span class="token punctuation">,</span>
    <span class="token string">'src/assets/fonts/**'</span><span class="token punctuation">,</span>
    <span class="token string">'public/**'</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span> bs<span class="token punctuation">.</span>reload<span class="token punctuation">)</span>

  bs<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    notify<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    port<span class="token operator">:</span> <span class="token number">2080</span><span class="token punctuation">,</span>
    open<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// files: 'dist/**',</span>
    server<span class="token operator">:</span> <span class="token punctuation">{</span>
      baseDir<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'temp'</span><span class="token punctuation">,</span> <span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token string">'public'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      routes<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">'/node_modules'</span><span class="token operator">:</span> <span class="token string">'node_modules'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">useref</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'temp/*.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'temp'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">useref</span><span class="token punctuation">(</span><span class="token punctuation">{</span> searchPath<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'temp'</span><span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 通过 useref 会产生 3 种文件 html js css</span>
    <span class="token operator">/</span><span class="token operator">/</span> 针对不同的文件我们需要做不同的操作
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token regex">/\.js$/</span><span class="token punctuation">,</span> plugins<span class="token punctuation">.</span><span class="token function">uglify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token regex">/\.css$/</span><span class="token punctuation">,</span> plugins<span class="token punctuation">.</span><span class="token function">cleanCss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token regex">/\.html$/</span><span class="token punctuation">,</span> plugins<span class="token punctuation">.</span><span class="token function">htmlmin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      collapseWhitespace<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      minifyCSS<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      minifyJS<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> compile <span class="token operator">=</span> <span class="token function">parallel</span><span class="token punctuation">(</span>style<span class="token punctuation">,</span> script<span class="token punctuation">,</span> page<span class="token punctuation">)</span>

<span class="token operator">/</span><span class="token operator">/</span> 上线之前执行的任务
<span class="token keyword">const</span> build <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>
  clean<span class="token punctuation">,</span>
  <span class="token function">parallel</span><span class="token punctuation">(</span>
    <span class="token function">series</span><span class="token punctuation">(</span>compile<span class="token punctuation">,</span> useref<span class="token punctuation">)</span><span class="token punctuation">,</span>
    image<span class="token punctuation">,</span>
    font<span class="token punctuation">,</span>
    extra
  <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> dev <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>compile<span class="token punctuation">,</span> serve<span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  clean<span class="token punctuation">,</span>
  build<span class="token punctuation">,</span>
  dev
<span class="token punctuation">}</span>
</code></pre></div><h3 id="项目配置scripts脚本"><a href="#项目配置scripts脚本" class="header-anchor">#</a> 项目配置scripts脚本</h3> <p>给项目的package.json中添加几个命令，这样我们交给别人去使用的话，也能非常容易明白</p> <div class="language-json extra-class"><pre class="language-json"><code> <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;clean&quot;</span><span class="token operator">:</span> <span class="token string">&quot;gulp clean&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;gulp build&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;gulp dev&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>在gitignore中去配置忽略的目录 temp 和 dist</p> <h2 id="封装工作流"><a href="#封装工作流" class="header-anchor">#</a> 封装工作流</h2> <p>如果我们要开发多个同类型的项目，那么他们的构建工作流应该是一样的，这样我们就需要在这些项目中重复的去使用这些构建任务，这样我们就需要去复用gulpfile</p> <img src="/blog/img/gulpflow.png" alt="queue" class="custom"> <p>我们先安装一个脚手架初始化一个项目</p> <p><code>yarn global zce-cli</code></p> <p>然后初始化一个基本的项目</p> <p><code>zce init nm &lt;project-name&gt;</code></p> <img src="/blog/img/initProject.png" alt="queue" class="custom"> <p>这样 我们的 项目就初始化完成了</p> <h3 id="提取-gulpfile-文件"><a href="#提取-gulpfile-文件" class="header-anchor">#</a> 提取 Gulpfile 文件</h3> <p>我们把之前项目中的gulpfile文件中的内容全部拷贝到txm-pages项目中lib目录下的index.js文件里，这个index.js文件是txm-pages的一个入口文件，</p> <p>然后我们在把之前项目中的开发依赖放到txm-pages项目中的dependencies 里，因为在引入模块的时候它只会自动的去安装</p> <p>dependencies 里面的依赖，这个说明这些依赖是我们开发这个项目所用的依赖</p> <p>接下来我们在之前的项目中去使用txm-pages，正常来说我们需要将这个模块发布到npm，但是我们还在开发阶段，所以我们将txm-pages这个模块link到全局</p> <img src="/blog/img/devFlow.png" alt="queue" class="custom"> <p>可以看到我们把txm-pages link到全局后，然后在txm-gulp-demo项目中通过 yarn link &quot;txm-pages&quot;的方式将其link到项目里，然后项目里面自动就多了node_modules这个文件夹</p> <p>接下来我们就可以去使用这个模块了，在txm-pages中的index.js文件中导出的是一个gulpfile,而我们的demo项目中缺少的就是这个，所以我们在gulpfile中可以直接这么写</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'txm-pages'</span><span class="token punctuation">)</span>
</code></pre></div><p>但是现在我们还不能执行任务，它会报错gulp找不到，这个是我们可以先把他们安装到开发依赖来解决这个问题，其实发布后就不会存在这个问题了，因为它会去找node_modules目录下的bin目录下的命令，现在是没有的，所以它会报错，当我们发布后，它就会自动安装对应的依赖</p> <h3 id="提取配置文件"><a href="#提取配置文件" class="header-anchor">#</a> 提取配置文件</h3> <p>我们可以通过一种约定大于配置的形式来规定一个配置文件，类似于Vue中的vue.config.js文件，我们这设置为pages.config.js</p> <p>在公共模块 里面有一些不属于它自己的数据，比如说data，这个应该是各自项目中的，我们先把这个拿出去放在pages.config.js中,这时候我们需要动态的去读取当前项目中的配置，可以通过process.cwd()方法拿到当前命令行的工作目录</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token comment">// 获取当前命令行的目录</span>
<span class="token keyword">const</span> cwd <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// default config</span>
<span class="token punctuation">}</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> loadConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> <span class="token string">'pages.config.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  config <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> config<span class="token punctuation">,</span> loadConfig<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre></div><p>然后page任务就需要稍作修改</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">page</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/*.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">swig</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data<span class="token operator">:</span> config<span class="token punctuation">.</span>data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'temp'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后还有script任务也需要稍作修改</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">script</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'src/assets/scripts/*.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> <span class="token string">'src'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">babel</span><span class="token punctuation">(</span><span class="token punctuation">{</span> presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span><span class="token string">'temp'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后我们执行build任务，可以发现他是可以正常工作的，说明我们的gulpfile的提取是没有问题的</p> <h3 id="抽象路径配置"><a href="#抽象路径配置" class="header-anchor">#</a> 抽象路径配置</h3> <p>我们在工作流中很多路径配置都是写死的，我们应该提供一个可以修改的配置出去，然后默认采用写死的数据，这样可配的方式更加灵活一些,修改完的index.js文件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> src<span class="token punctuation">,</span> dest<span class="token punctuation">,</span> parallel<span class="token punctuation">,</span> series<span class="token punctuation">,</span> watch <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> del <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'del'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> browserSync <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'browser-sync'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> loadPlugins <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp-load-plugins'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> plugins <span class="token operator">=</span> <span class="token function">loadPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> bs <span class="token operator">=</span> browserSync<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 获取当前命令行的目录</span>
<span class="token keyword">const</span> cwd <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  build<span class="token operator">:</span> <span class="token punctuation">{</span>
    src<span class="token operator">:</span> <span class="token string">'src'</span><span class="token punctuation">,</span>
    dist<span class="token operator">:</span> <span class="token string">'dist'</span><span class="token punctuation">,</span>
    temp<span class="token operator">:</span> <span class="token string">'temp'</span><span class="token punctuation">,</span>
    <span class="token keyword">public</span><span class="token operator">:</span> <span class="token string">'public'</span><span class="token punctuation">,</span>
    paths<span class="token operator">:</span> <span class="token punctuation">{</span>
      styles<span class="token operator">:</span> <span class="token string">'assets/styles/*.scss'</span><span class="token punctuation">,</span>
      scripts<span class="token operator">:</span> <span class="token string">'assets/scripts/*.js'</span><span class="token punctuation">,</span>
      pages<span class="token operator">:</span> <span class="token string">'*.html'</span><span class="token punctuation">,</span>
      images<span class="token operator">:</span> <span class="token string">'assets/images/**'</span><span class="token punctuation">,</span>
      fonts<span class="token operator">:</span> <span class="token string">'assets/fonts/**'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> loadConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> <span class="token string">'pages.config.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  config <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> config<span class="token punctuation">,</span> loadConfig<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">clean</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">[</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>dist<span class="token punctuation">,</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>temp<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">style</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>paths<span class="token punctuation">.</span>styles<span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>src<span class="token punctuation">,</span> cwd<span class="token operator">:</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>src <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">sass</span><span class="token punctuation">(</span><span class="token punctuation">{</span> outputStyle<span class="token operator">:</span> <span class="token string">'expanded'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>temp<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">script</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>paths<span class="token punctuation">.</span>scripts<span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>src<span class="token punctuation">,</span> cwd<span class="token operator">:</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>src <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">babel</span><span class="token punctuation">(</span><span class="token punctuation">{</span> presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>temp<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">page</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>paths<span class="token punctuation">.</span>pages<span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>src<span class="token punctuation">,</span> cwd<span class="token operator">:</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>src <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">swig</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data<span class="token operator">:</span> config<span class="token punctuation">.</span>data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>temp<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>bs<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">{</span> stream<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">image</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>paths<span class="token punctuation">.</span>images<span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>src<span class="token punctuation">,</span> cwd<span class="token operator">:</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>src <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>dist<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">font</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>paths<span class="token punctuation">.</span>fonts<span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>src<span class="token punctuation">,</span> cwd<span class="token operator">:</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>src <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">imagemin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>dist<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">extra</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span><span class="token string">'**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>public<span class="token punctuation">,</span> cwd<span class="token operator">:</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>public <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>dist<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">serve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">watch</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>paths<span class="token punctuation">.</span>styles<span class="token punctuation">,</span> <span class="token punctuation">{</span> cwd<span class="token operator">:</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>src <span class="token punctuation">}</span><span class="token punctuation">,</span> style<span class="token punctuation">)</span>
  <span class="token function">watch</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>paths<span class="token punctuation">.</span>scripts<span class="token punctuation">,</span> <span class="token punctuation">{</span> cwd<span class="token operator">:</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>src <span class="token punctuation">}</span><span class="token punctuation">,</span> script<span class="token punctuation">)</span>
  <span class="token function">watch</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>paths<span class="token punctuation">.</span>pages<span class="token punctuation">,</span> <span class="token punctuation">{</span> cwd<span class="token operator">:</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>src <span class="token punctuation">}</span><span class="token punctuation">,</span> page<span class="token punctuation">)</span>
  <span class="token comment">// watch('src/assets/images/**', image)</span>
  <span class="token operator">/</span><span class="token operator">/</span> <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'src/assets/fonts/**'</span><span class="token punctuation">,</span> font<span class="token punctuation">)</span>
  <span class="token comment">// watch('public/**', extra)</span>

  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>paths<span class="token punctuation">.</span>images<span class="token punctuation">,</span>
    config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>paths<span class="token punctuation">.</span>fonts<span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> cwd<span class="token operator">:</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>src <span class="token punctuation">}</span><span class="token punctuation">,</span> bs<span class="token punctuation">.</span>reload<span class="token punctuation">)</span>

  <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'**'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> cwd<span class="token operator">:</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>public <span class="token punctuation">}</span><span class="token punctuation">,</span> bs<span class="token punctuation">.</span>reload<span class="token punctuation">)</span>

  bs<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    notify<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    port<span class="token operator">:</span> <span class="token number">2080</span><span class="token punctuation">,</span>
    open<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token operator">/</span><span class="token operator">/</span> files<span class="token operator">:</span> <span class="token string">'dist/**'</span><span class="token punctuation">,</span>
    server<span class="token operator">:</span> <span class="token punctuation">{</span>
      baseDir<span class="token operator">:</span> <span class="token punctuation">[</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>temp<span class="token punctuation">,</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>src<span class="token punctuation">,</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>public<span class="token punctuation">]</span><span class="token punctuation">,</span>
      routes<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">'/node_modules'</span><span class="token operator">:</span> <span class="token string">'node_modules'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">useref</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">src</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>paths<span class="token punctuation">.</span>pages<span class="token punctuation">,</span> <span class="token punctuation">{</span> base<span class="token operator">:</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>temp<span class="token punctuation">,</span> cwd<span class="token operator">:</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>temp <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">useref</span><span class="token punctuation">(</span><span class="token punctuation">{</span> searchPath<span class="token operator">:</span> <span class="token punctuation">[</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>temp<span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 通过 useref 会产生 3 种文件 html js css</span>
    <span class="token operator">/</span><span class="token operator">/</span> 针对不同的文件我们需要做不同的操作
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token regex">/\.js$/</span><span class="token punctuation">,</span> plugins<span class="token punctuation">.</span><span class="token function">uglify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token regex">/\.css$/</span><span class="token punctuation">,</span> plugins<span class="token punctuation">.</span><span class="token function">cleanCss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>plugins<span class="token punctuation">.</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token regex">/\.html$/</span><span class="token punctuation">,</span> plugins<span class="token punctuation">.</span><span class="token function">htmlmin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      collapseWhitespace<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      minifyCSS<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      minifyJS<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">dest</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>dist<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> compile <span class="token operator">=</span> <span class="token function">parallel</span><span class="token punctuation">(</span>style<span class="token punctuation">,</span> script<span class="token punctuation">,</span> page<span class="token punctuation">)</span>

<span class="token operator">/</span><span class="token operator">/</span> 上线之前执行的任务
<span class="token keyword">const</span> build <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>
  clean<span class="token punctuation">,</span>
  <span class="token function">parallel</span><span class="token punctuation">(</span>
    <span class="token function">series</span><span class="token punctuation">(</span>compile<span class="token punctuation">,</span> useref<span class="token punctuation">)</span><span class="token punctuation">,</span>
    image<span class="token punctuation">,</span>
    font<span class="token punctuation">,</span>
    extra
  <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> dev <span class="token operator">=</span> <span class="token function">series</span><span class="token punctuation">(</span>compile<span class="token punctuation">,</span> serve<span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  clean<span class="token punctuation">,</span>
  build<span class="token punctuation">,</span>
  dev
<span class="token punctuation">}</span>
</code></pre></div><h3 id="包装-gulp-cli"><a href="#包装-gulp-cli" class="header-anchor">#</a> 包装 Gulp Cli</h3> <p>我们现在这个工作流就已经开发完成了，但是我们在其他项目中使用的时候，需要创建gulpfile和pages.config.js两个文件，对于我们来说pages.config.js是必要的，但是gulefile它只是做了一个导出的工作，不是必要的，所以我们来包装一下，使得我们不需要gulpfile文件也能正常运行工作流</p> <p>gulp在工作的时候可以手动去指定gulpfile文件的位置</p> <p><code>yarn gulp build --gulpfile ./node_modules/txm-pages/lib/index.js --cwd .</code></p> <p>我们把gulpfile文件删除了，执行这个命令也是可以的，但是这个命令就显得不是那么简洁，我们可以在txm-pages中提供一个Cli，然后它自动的传递这些参数，然后内部去调用gulp的可执行程序，那么外部就不需要gulefile这个文件了，我们就等于是把gulp完全包装到这个模块中</p> <p>我们新建一个bin目录，然后创建一个txm-pages.js的文件作为cli程序的入口</p> <p>在package.json中添加bin字段</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;bin&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bin/txm-pages.js&quot;</span>
</code></pre></div><p>然后再txm-pages.js中去声明注释，因为他是作为cli的入口文件</p> <div class="language-js extra-class"><pre class="language-js"><code>#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node
</code></pre></div><p>我们再命令行中输入参数可以通过process.argv来拿到，它是一个数组</p> <p>我们可以看到gulp在执行的时候也是调用了gulp-cli然后去执行的</p> <img src="/blog/img/gulpCli.png" alt="queue" class="custom"> <p>所以我们直接载入gulp就行了,当然，在执行之前我们可以将参数push到process.argv中，这样也就等同于我们在命令行输入参数</p> <div class="language-js extra-class"><pre class="language-js"><code>#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node

process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'--cwd'</span><span class="token punctuation">)</span>
process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'--gulpfile'</span><span class="token punctuation">)</span>
process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'..'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp/bin/gulp'</span><span class="token punctuation">)</span>
</code></pre></div><p>在txm-pages项目中先执行一下yarn unlink 然后再执行 yarn link</p> <p>重新link一下，然后我们进入到demo项目中去执行一下任务</p> <p><code>txm-pages build</code>发现也是没有问题的</p> <h3 id="发布"><a href="#发布" class="header-anchor">#</a> 发布</h3> <p>发布之前先做一个小小的修改，再package.json中的files中添加bin目录，因为我们需要将lib和bin都发布，它默认只会发布files下面的目录，</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token string">&quot;files&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;lib&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;bin&quot;</span>
  <span class="token punctuation">]</span>
</code></pre></div><p>然后发布一下</p> <img src="/blog/img/txmpublish.png" alt="queue" class="custom"> <p>发布完成之后我们就可以尝试在一个新项目中去是使用它</p> <p>我们可以新建一个项目，然后  它应该有一个和demo项目相同的目录结构，然后我们初始化一个package.json并安装txm-pages模块，然后执行<code>yarn txm-pages build</code>，也是正常的，说明我们的发布是没有问题的</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">2020年7月13日星期一凌晨2点00分</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/note/脚手架工具.html" class="prev">
        脚手架工具
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/blog/assets/js/app.7268b5d5.js" defer></script><script src="/blog/assets/js/2.bfb3ed95.js" defer></script><script src="/blog/assets/js/27.2fd5153a.js" defer></script><script src="/blog/assets/js/3.38b041cb.js" defer></script>
  </body>
</html>
