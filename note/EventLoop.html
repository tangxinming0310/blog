<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>EventLoop | 橘子</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/blog/favicon.ico">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="mask-icon" href="/blog/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <meta name="description" content="明日可期">
    <meta name="author" content="bright">
    <meta name="keywords" content="前端 随记 笔记">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileColor" content="#000000">
    <link rel="preload" href="/blog/assets/css/0.styles.96e855cf.css" as="style"><link rel="preload" href="/blog/assets/js/app.846c2af7.js" as="script"><link rel="preload" href="/blog/assets/js/2.7baf1e30.js" as="script"><link rel="preload" href="/blog/assets/js/17.79d2e86b.js" as="script"><link rel="preload" href="/blog/assets/js/3.e02a7905.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.86785721.js"><link rel="prefetch" href="/blog/assets/js/11.26ca4aa6.js"><link rel="prefetch" href="/blog/assets/js/12.9280f5df.js"><link rel="prefetch" href="/blog/assets/js/13.491d5f4c.js"><link rel="prefetch" href="/blog/assets/js/14.06ac742d.js"><link rel="prefetch" href="/blog/assets/js/15.30a8a42b.js"><link rel="prefetch" href="/blog/assets/js/16.26f51be0.js"><link rel="prefetch" href="/blog/assets/js/18.3e102323.js"><link rel="prefetch" href="/blog/assets/js/19.3834056b.js"><link rel="prefetch" href="/blog/assets/js/20.e411308e.js"><link rel="prefetch" href="/blog/assets/js/21.68d4b979.js"><link rel="prefetch" href="/blog/assets/js/22.ba9b864c.js"><link rel="prefetch" href="/blog/assets/js/23.a4bf6015.js"><link rel="prefetch" href="/blog/assets/js/24.0e73f53a.js"><link rel="prefetch" href="/blog/assets/js/25.7766fb26.js"><link rel="prefetch" href="/blog/assets/js/26.3cd2ed30.js"><link rel="prefetch" href="/blog/assets/js/27.e2861c31.js"><link rel="prefetch" href="/blog/assets/js/28.565b27ef.js"><link rel="prefetch" href="/blog/assets/js/29.81874df5.js"><link rel="prefetch" href="/blog/assets/js/4.c7236fd3.js"><link rel="prefetch" href="/blog/assets/js/5.956a0a9c.js"><link rel="prefetch" href="/blog/assets/js/6.783055ce.js"><link rel="prefetch" href="/blog/assets/js/7.29a4535f.js"><link rel="prefetch" href="/blog/assets/js/8.454ed7dd.js"><link rel="prefetch" href="/blog/assets/js/9.60594020.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.96e855cf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">橘子</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/network/" class="nav-link">
  浏览器
</a></div><div class="nav-item"><a href="/blog/note/ES6.html" class="nav-link">
  随记
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/frame/Vue/base.html" class="nav-link">
  Vue
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/network/" class="nav-link">
  浏览器
</a></div><div class="nav-item"><a href="/blog/note/ES6.html" class="nav-link">
  随记
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/frame/Vue/base.html" class="nav-link">
  Vue
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>note</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/note/ES6.html" class="sidebar-link">ES 新特性</a></li><li><a href="/blog/note/EventLoop.html" class="active sidebar-link">EventLoop</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/note/EventLoop.html#前置知识（栈、队列的基本概念）" class="sidebar-link">前置知识（栈、队列的基本概念）</a></li><li class="sidebar-sub-header"><a href="/blog/note/EventLoop.html#同步任务与异步任务" class="sidebar-link">同步任务与异步任务</a></li><li class="sidebar-sub-header"><a href="/blog/note/EventLoop.html#宏任务与微任务" class="sidebar-link">宏任务与微任务</a></li><li class="sidebar-sub-header"><a href="/blog/note/EventLoop.html#eventloop执行顺序" class="sidebar-link">EventLoop执行顺序</a></li></ul></li><li><a href="/blog/note/FP.html" class="sidebar-link">函数式编程(FP)</a></li><li><a href="/blog/note/JS性能优化.html" class="sidebar-link">JS性能优化</a></li><li><a href="/blog/note/Promise.html" class="sidebar-link">Promise源码实现诱导版</a></li><li><a href="/blog/note/" class="sidebar-link">日常随记</a></li><li><a href="/blog/note/Rollup.html" class="sidebar-link">Rollup</a></li><li><a href="/blog/note/TS.html" class="sidebar-link">TypeScript</a></li><li><a href="/blog/note/webpack.html" class="sidebar-link">Webpack</a></li><li><a href="/blog/note/工程化.html" class="sidebar-link">工程化</a></li><li><a href="/blog/note/脚手架工具.html" class="sidebar-link">脚手架工具</a></li><li><a href="/blog/note/自动化构建.html" class="sidebar-link">自动化构建</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="前置知识（栈、队列的基本概念）"><a href="#前置知识（栈、队列的基本概念）" class="header-anchor">#</a> 前置知识（栈、队列的基本概念）</h2> <h3 id="栈（stack）"><a href="#栈（stack）" class="header-anchor">#</a> 栈（Stack）</h3> <p><strong>栈</strong>是一种先进后出的数据结构，先入栈的被压入栈低，最后入栈的数据在栈顶，出栈的时候从栈顶开始弹出数据（弹栈）</p> <h3 id="队列（queue）"><a href="#队列（queue）" class="header-anchor">#</a> 队列（Queue）</h3> <p><strong>队列</strong>是一种先进先出的数据结构，队列从一端入队，从另一端出队
<img src="/blog/queue.png" alt="queue" class="custom"></p> <h2 id="同步任务与异步任务"><a href="#同步任务与异步任务" class="header-anchor">#</a> 同步任务与异步任务</h2> <p>js是单线程的，也就是说所有的任务都需要排队，前一个任务执行完毕，才会执行后一个任务，如果前一个任务耗时很长，那么后一个任务就需要一直等待，所以js的任务分为了<code>同步任务</code>和<code>异步任务</code>。</p> <ul><li>同步任务：调用立即得到结果的任务，同步任务是在主线程上排队执行的任务，只有前一个任务执行完毕，才会执行后一个任务。</li> <li>异步任务：调用无法立即得到结果的任务，异步任务不进入主线程，而是进入<code>任务队列（task queue）</code>，只有当<code>任务队列</code>通知主线程，某个异步任务可以执行了，该任务才会进入主线程执行。
JS引擎遇见异步任务（网络请求，setTimeout延时等），会交给某个线程单独去维护异步任务，等待某个时机（网络请求成功，延时结束等），然后由事件触发将异步任务的回调加入到<code>异步队列</code>,<code>异步队列</code>中的回调函数等待被执行。</li></ul> <img src="/blog/loop.png" alt="loop" class="custom"> <p>举个例子：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script start'</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timer 1 over'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timer 2 over'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script end'</span><span class="token punctuation">)</span>

<span class="token comment">// script start</span>
<span class="token comment">// script end</span>
<span class="token comment">// timer 2 over</span>
<span class="token comment">// timer 1 over</span>
</code></pre></div><p><code>timer 2 over</code>0毫秒后添加到任务队列队尾，<code>timer 1 over</code>1秒添加到任务队列队尾，等待主线程任务执行完，从队头依次执行任务队列中的任务</p> <h2 id="宏任务与微任务"><a href="#宏任务与微任务" class="header-anchor">#</a> 宏任务与微任务</h2> <p>在<code>js</code>中，任务被分为两种，一种是宏任务<code>MacroTask</code>，一种是微任务<code>MicroTask</code></p> <ul><li>宏任务包括：<code>script</code>、<code>setTimeout</code>、<code>setInterval</code>、<code>setImmediate</code>、<code>I/O</code>、<code>UI rendering</code></li> <li>微任务包括：<code>MutationObserver</code>、<code>Promise.then()或catch()</code>、<code>Node独有的process.nextTick</code>、<code>Promise为基础开发的技术，如fetch</code></li></ul> <p>举个例子：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script start'</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timer over'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise1'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise2'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script end'</span><span class="token punctuation">)</span>

<span class="token comment">// script start</span>
<span class="token comment">// script end</span>
<span class="token comment">// promise1</span>
<span class="token comment">// promise2</span>
<span class="token comment">// timer over</span>
</code></pre></div><p>在挂起任务时，JS 引擎会将所有任务按照类别分到这两个队列中，首先在 宏任务 的队列中取出第一个任务，执行完毕后取出 微任务 队列中的所有任务顺序执行；之后再取 宏任务，周而复始，直至两个队列的任务都取完</p> <img src="/blog/eventloop.png" alt="eventloop" class="custom"> <h2 id="eventloop执行顺序"><a href="#eventloop执行顺序" class="header-anchor">#</a> EventLoop执行顺序</h2> <p>总的来说，<code>eventloop</code>执行过程如下：</p> <ol><li>一开始一整个脚本作为一个宏任务执行</li> <li>执行过程中同步代码直接执行，异步任务进入任务队列，其中宏任务进入宏任务队列，微任务进入微任务队列</li> <li>当前宏任务执行完出队，检查微任务队列列表，有则依次执行完毕</li> <li>执行浏览器的UI渲染工作</li> <li>检查是否有<code>Web Worker</code>任务，有则执行</li> <li>执行完本轮的宏任务，回到2，依次循环，直到宏任务和微任务队列都为空</li></ol></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">2020年5月14日星期四晚上9点51分</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/note/ES6.html" class="prev">
        ES 新特性
      </a></span> <span class="next"><a href="/blog/note/FP.html">
        函数式编程(FP)
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/blog/assets/js/app.846c2af7.js" defer></script><script src="/blog/assets/js/2.7baf1e30.js" defer></script><script src="/blog/assets/js/17.79d2e86b.js" defer></script><script src="/blog/assets/js/3.e02a7905.js" defer></script>
  </body>
</html>
