<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>手写一个自己的 VueRouter | 橘子</title>
    <meta name="generator" content="VuePress 1.5.3">
    <link rel="icon" href="/blog/favicon.ico">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="mask-icon" href="/blog/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <meta name="description" content="明日可期">
    <meta name="author" content="bright">
    <meta name="keywords" content="前端 随记 笔记">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileColor" content="#000000">
    <link rel="preload" href="/blog/assets/css/0.styles.8a31d08e.css" as="style"><link rel="preload" href="/blog/assets/js/app.7268b5d5.js" as="script"><link rel="preload" href="/blog/assets/js/2.bfb3ed95.js" as="script"><link rel="preload" href="/blog/assets/js/9.f5c94ac4.js" as="script"><link rel="preload" href="/blog/assets/js/3.38b041cb.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.e22ab2a4.js"><link rel="prefetch" href="/blog/assets/js/11.9b6afde3.js"><link rel="prefetch" href="/blog/assets/js/12.1881e8b2.js"><link rel="prefetch" href="/blog/assets/js/13.591e9158.js"><link rel="prefetch" href="/blog/assets/js/14.03b9db9c.js"><link rel="prefetch" href="/blog/assets/js/15.8acf6f69.js"><link rel="prefetch" href="/blog/assets/js/16.887430fe.js"><link rel="prefetch" href="/blog/assets/js/17.018b2b77.js"><link rel="prefetch" href="/blog/assets/js/18.dcc85b92.js"><link rel="prefetch" href="/blog/assets/js/19.c9b2a5b0.js"><link rel="prefetch" href="/blog/assets/js/20.cd933d25.js"><link rel="prefetch" href="/blog/assets/js/21.5887b2f8.js"><link rel="prefetch" href="/blog/assets/js/22.5cb0bf92.js"><link rel="prefetch" href="/blog/assets/js/23.bff58062.js"><link rel="prefetch" href="/blog/assets/js/24.145710ef.js"><link rel="prefetch" href="/blog/assets/js/25.6e7a99f7.js"><link rel="prefetch" href="/blog/assets/js/26.6251e442.js"><link rel="prefetch" href="/blog/assets/js/27.2fd5153a.js"><link rel="prefetch" href="/blog/assets/js/28.68c69371.js"><link rel="prefetch" href="/blog/assets/js/4.a5e4891f.js"><link rel="prefetch" href="/blog/assets/js/5.7165873c.js"><link rel="prefetch" href="/blog/assets/js/6.f680b873.js"><link rel="prefetch" href="/blog/assets/js/7.17ca32f2.js"><link rel="prefetch" href="/blog/assets/js/8.7acd39b4.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.8a31d08e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">橘子</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/network/" class="nav-link">
  浏览器
</a></div><div class="nav-item"><a href="/blog/note/ES6.html" class="nav-link">
  随记
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/frame/Vue/base.html" class="nav-link">
  Vue
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/network/" class="nav-link">
  浏览器
</a></div><div class="nav-item"><a href="/blog/note/ES6.html" class="nav-link">
  随记
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/frame/Vue/base.html" class="nav-link">
  Vue
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/frame/Vue/MiniVue.html" class="sidebar-link">手写一个简单的自己的Vue</a></li><li><a href="/blog/frame/Vue/VirtualDOM.html" class="sidebar-link">Virtual DOM</a></li><li><a href="/blog/frame/Vue/VueRouter.html" aria-current="page" class="active sidebar-link">手写一个自己的 VueRouter</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frame/Vue/VueRouter.html#hash-模式" class="sidebar-link">Hash 模式</a></li><li class="sidebar-sub-header"><a href="/blog/frame/Vue/VueRouter.html#history-模式" class="sidebar-link">History 模式</a></li><li class="sidebar-sub-header"><a href="/blog/frame/Vue/VueRouter.html#实现一个简单版本的vuerouter" class="sidebar-link">实现一个简单版本的VueRouter</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/frame/Vue/VueRouter.html#vuerouter-分析" class="sidebar-link">VueRouter 分析</a></li><li class="sidebar-sub-header"><a href="/blog/frame/Vue/VueRouter.html#实现vuerouter-install-方法" class="sidebar-link">实现VueRouter install 方法</a></li><li class="sidebar-sub-header"><a href="/blog/frame/Vue/VueRouter.html#实现-vuerouter-构造函数" class="sidebar-link">实现 VueRouter 构造函数</a></li><li class="sidebar-sub-header"><a href="/blog/frame/Vue/VueRouter.html#实现-createroutemap" class="sidebar-link">实现 createRouteMap</a></li><li class="sidebar-sub-header"><a href="/blog/frame/Vue/VueRouter.html#实现-vuerouter-initcomponents" class="sidebar-link">实现 VueRouter initComponents</a></li><li class="sidebar-sub-header"><a href="/blog/frame/Vue/VueRouter.html#initevent" class="sidebar-link">initEvent</a></li><li class="sidebar-sub-header"><a href="/blog/frame/Vue/VueRouter.html#处理浏览器刷新问题" class="sidebar-link">处理浏览器刷新问题</a></li><li class="sidebar-sub-header"><a href="/blog/frame/Vue/VueRouter.html#完整版代码（history）" class="sidebar-link">完整版代码（history）</a></li><li class="sidebar-sub-header"><a href="/blog/frame/Vue/VueRouter.html#有hash模式和history模式的完整版代码" class="sidebar-link">有hash模式和history模式的完整版代码</a></li></ul></li></ul></li><li><a href="/blog/frame/Vue/base.html" class="sidebar-link">Vue</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>VueRouter 有两种模式，一种是 Hash 模式，一种是 History 模式，下面来看下两种模式的区别</p> <h2 id="hash-模式"><a href="#hash-模式" class="header-anchor">#</a> Hash 模式</h2> <ul><li><p>将 URL 中 # 后面的内容作为路径地址</p> <blockquote><p>可以直接使用 location.url 来切换地址，如果只是改变了 # 后面的内容，浏览器不会向服务器请求这个地址，但是会把这个地址记录到浏览器的访问历史中</p></blockquote></li> <li><p>监听hashchange 事件</p> <blockquote><p>hash 改变后通过 监听 hashchange 事件可以根据当前路由找到对应的组件并重新渲染</p></blockquote></li> <li><p>根据当前路由找到对应的组件重新渲染</p></li></ul> <h2 id="history-模式"><a href="#history-模式" class="header-anchor">#</a> History 模式</h2> <ul><li><p>通过 history.pushState() 方法改变地址栏</p> <blockquote><p>pushState 方法仅仅是改变地址栏，并把当前地址记录到浏览器的访问历史中，并不会真真跳转到指定的路径，浏览器不会向服务器发送请求</p></blockquote></li> <li><p>监听 popState 事件</p> <blockquote><p>通过监听 popState 事件，可以监听到浏览器地址操作的变化，在 popState 的操作函数中可以记录该变后的地址，注意：当调用 pushState 或者 replaceState 的时候不会触发该事件，当点击浏览器的前进和后退按钮的时候，或者调用 history 的 back 和 forward 方法时，事件才会被触发</p></blockquote></li> <li><p>根据当前路由地址找到对应组件重新渲染</p></li></ul> <h2 id="实现一个简单版本的vuerouter"><a href="#实现一个简单版本的vuerouter" class="header-anchor">#</a> 实现一个简单版本的VueRouter</h2> <h3 id="vuerouter-分析"><a href="#vuerouter-分析" class="header-anchor">#</a> VueRouter 分析</h3> <p>先看一下 Vue Router 的使用</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//  router/index.js</span>
<span class="token comment">// 注册插件</span>
Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>VueRouer<span class="token punctuation">)</span>
<span class="token comment">// 创建路由对象</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VueRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    routes<span class="token operator">:</span> <span class="token punctuation">[</span>
    	<span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'home'</span><span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> homeComponent<span class="token punctuation">}</span>
	<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// main.js</span>
<span class="token comment">// 创建 Vue 实例，注册 router 对象</span>
<span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    router<span class="token punctuation">,</span>
    <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token parameter">h</span> <span class="token operator">=&gt;</span> <span class="token function">h</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
</code></pre></div><p>Vue.use 可以传入一个函数或者对象，如果是函数，会直接执行该函数，如果是一个对象，会调用对象中的 install 方法</p> <p>在 new VueRouter 的时候传入一个对象，说明它是一个对象或者是一个类，里面应该有一个 install 方法，构造函数接收一个路由规则对象</p> <p>根据 VueRouter  的使用，我们画好了一个类图</p> <img src="/blog/img/vuerouter.png" alt="queue" class="custom"> <p>options 的作用是记录构造函数中传入的对象</p> <p>routerMap 是一个对象，用来记录路由和组件之间的对应关系</p> <p>data 是一个对象，拥有一个 current 属性，用来记录当前路由地址，它是一个响应式的对象，因为路由地址发生变化后，对应的组件要自动更新，通过 Vue.observable 方法可以将该对象变成响应式的</p> <p>install 用来实现 Vue  的插件机制</p> <p>init 用来调用 initEvent() createRouterMap() 和 initComponents 方法</p> <p>initEvent 是用来监听浏览器历史的变化</p> <p>createRouterMap 用来初始化 routerMap</p> <p>initComponents 用来创建 router-view 和 router-link 两个组件</p> <h3 id="实现vuerouter-install-方法"><a href="#实现vuerouter-install-方法" class="header-anchor">#</a> 实现VueRouter install 方法</h3> <p>接下来，我们来实现自己的 VueRouter，首先实现它的 install 方法</p> <p>install 方法主要做了三件事情</p> <ol><li>判断当前插件是否已经安装</li> <li>把 Vue 构造函数记录到全局</li> <li>把创建 Vue 实例时候传入的 router 对象注入到 Vue 实例上</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> _Vue <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">VueRouter</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">install</span> <span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. 判断当前插件是否已经安装</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>VueRouter<span class="token punctuation">.</span>install<span class="token punctuation">.</span>installed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    VueRouter<span class="token punctuation">.</span>install<span class="token punctuation">.</span>installed <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token comment">// 2. 把 Vue 构造函数记录到全局</span>
    _Vue <span class="token operator">=</span> Vue
    <span class="token comment">// 3. 把创建 Vue 实例时候传入的 router 对象注入到 Vue 实例上</span>
    <span class="token comment">// 在 new Vue 的时候传入的 router 对象存在于 vue 的 $optoins 中，没有在 Vue 的实例上，所以需要注入到 Vue 的实例上</span>
    <span class="token comment">// 要获取到 $options 中的 router 对象，需要在可以获取到 vue 实例的时候</span>
    <span class="token comment">// 通过使用 混入 在混入的 beforeCreate 我们可以获取到 vue 实例</span>
    _Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// 因为这个混入在所有的实例和组件中都会有且会执行</span>
      <span class="token comment">// 这个钩子函数会被执行很多次，但是这个挂载只需要执行一次</span>
      <span class="token comment">// 所以需要判断需要判断实例上是否有 router 对象，因为组件是则不会有 router 对象</span>
      <span class="token function">beforeCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">_Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="实现-vuerouter-构造函数"><a href="#实现-vuerouter-构造函数" class="header-anchor">#</a> 实现 VueRouter 构造函数</h3> <p>在构造函数中，需要初始化 <code>options</code>、<code>data</code>和<code>routeMap</code></p> <p><code>routeMap</code>存储路径和组件的对应关系，键是路径，值是组件</p> <p><code>data</code>是一个响应式的对象，因为它需要存储当前的路由地址，当路由地址发生变化的时候需要触发视图更新</p> <div class="language-j extra-class"><pre class="language-j"><code>constructor <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token verb keyword">{</span>
    this<span class="token conjunction variable">.</span>options <span class="token verb keyword">=</span> options
    <span class="token adverb builtin">/</span><span class="token adverb builtin">/</span> 存储路径和组件的对应关系
    this<span class="token conjunction variable">.</span>routeMap <span class="token verb keyword">=</span> <span class="token verb keyword">{</span><span class="token adverb builtin">}</span>
    <span class="token adverb builtin">/</span><span class="token adverb builtin">/</span> data 是一个响应式的对象，因为它需要存储当前的路由地址，当路由地址发生变化的时候需要触发视图更新
    this<span class="token conjunction variable">.</span>data <span class="token verb keyword">=</span> <span class="token number">_</span>Vu<span class="token verb keyword">e.</span>observable<span class="token punctuation">(</span><span class="token verb keyword">{</span>
      curren<span class="token adverb builtin">t:</span> <span class="token string">'/'</span>
    <span class="token adverb builtin">}</span><span class="token punctuation">)</span>
  <span class="token adverb builtin">}</span>
</code></pre></div><h3 id="实现-createroutemap"><a href="#实现-createroutemap" class="header-anchor">#</a> 实现 createRouteMap</h3> <p>createRouteMap 方式的作用是将传入 options 中的路由规则解析到 routeMap 对象中</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token function">createRouteMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 遍历所有的路由规则，把路由规则解析成键值对的，存储到 routeMap 中</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>routeMap<span class="token punctuation">[</span>route<span class="token punctuation">.</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> route<span class="token punctuation">.</span>component
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="实现-vuerouter-initcomponents"><a href="#实现-vuerouter-initcomponents" class="header-anchor">#</a> 实现 VueRouter initComponents</h3> <p><code>initComponents</code> 方法的作用是创建 <code>router-link</code>和<code>router-view</code></p> <h4 id="router-link"><a href="#router-link" class="header-anchor">#</a> router-link</h4> <p>router-link 组件最后被渲染成一个超链接，它接收一个 to参数作为超链接的地址，内容在超链接之间</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-link</span> <span class="token attr-name">to</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Home<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-link</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>接下来就来实现创建一个 router-link 组件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">initComponents</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'router-link'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      props<span class="token operator">:</span> <span class="token punctuation">{</span>
        to<span class="token operator">:</span> String
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      template<span class="token operator">:</span> <span class="token string">'&lt;a :href=&quot;to&quot;&gt;&lt;slot&gt;&lt;/slot&gt;&lt;/a&gt;'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>然后去测试一下</p> <p>我们需要调用 initComponents 和 createRouteMap 这两个方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createRouteMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initComponents</span><span class="token punctuation">(</span>_Vue<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>这个 init 方法应该在 插件设置完成后调用</p> <div class="language-js extra-class"><pre class="language-js"><code>_Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">beforeCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">_Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router
            <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>利用 vue cli 工具创建一个 vue 项目，</p> <img src="/blog/img/owenRouter.png" alt="queue" class="custom"> <p>将 router 文件中原本引入的 vue-router 替换成我们自己写的 router</p> <p>然后去运行项目</p> <p>我们打开浏览器，页面上什么都没有输出，打开开发者面板</p> <img src="/blog/img/routererr.png" alt="queue" class="custom"> <p>可以看到控制台输出了两个错误，先不看第二错误，以为我们没有创建 router-view组件</p> <p>先看第一个错误，什么意思呢？</p> <p>错误信息说您正在使用Vue的仅运行时版本，而模板编译器不可用。 可以将模板预编译为渲染函数，也可以使用包含编译器的内部版本</p> <p>Vue 的构建版本</p> <ul><li>运行时版：不支持 template 模板，需要打包的时候提前编译</li> <li>完整版：包含运行时和编译器，体积比运行时版大 10k 左右，程序运行的时候把模板转换成 render 函数</li></ul> <p>有两种方式来解决这个问题</p> <h5 id="使用完整版本的-vue"><a href="#使用完整版本的-vue" class="header-anchor">#</a> 使用完整版本的 Vue</h5> <p>我们可以通过在根目录下创建 <code>vue.config.js</code>文件，然后配置</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    runtimeCompiler<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre></div><p>runtimeCompiler 代表是否使用包含运行时编译器的 Vue 构建版本，默认为 false，设置为 true 代表需要使用</p> <p>然后重新运行项目，在浏览器中访问</p> <img src="/blog/img/wz.png" alt="queue" class="custom"> <p>可以看到页面中的 router-link 已经被正常渲染出来了</p> <h5 id="运行时版本-vue-render函数"><a href="#运行时版本-vue-render函数" class="header-anchor">#</a> 运行时版本 Vue render函数</h5> <p>运行时版本的 vue 不支持 template ，但是可以直接写 render 函数来渲染组件</p> <div class="language-js extra-class"><pre class="language-js"><code> Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'router-link'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
     props<span class="token operator">:</span> <span class="token punctuation">{</span>
         to<span class="token operator">:</span> String
     <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token comment">// template: '&lt;a :href=&quot;to&quot;&gt;&lt;slot&gt;&lt;/slot&gt;&lt;/a&gt;'</span>
     <span class="token comment">// 参数 h 是 用来创建虚拟 DOM，接收三个参数</span>
     <span class="token comment">// 第一个参数是需要创建的标签名称</span>
     <span class="token comment">// 第二参数是创建标签的一些属性</span>
     <span class="token comment">// 第三个参数是生成的标签元素的子元素，是一个数组的形式</span>
     <span class="token function">render</span> <span class="token punctuation">(</span><span class="token parameter">h</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
             attrs<span class="token operator">:</span> <span class="token punctuation">{</span>
                 href<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>to
             <span class="token punctuation">}</span>
         <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">.</span>default<span class="token punctuation">]</span><span class="token punctuation">)</span>
     <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这个我们删除 vue.config.js 文件重新运行项目，可以看到 router-link 组件在页面中也被正常渲染了</p> <h4 id="router-view"><a href="#router-view" class="header-anchor">#</a> router-view</h4> <p>router-view 组件相当于一个占位符，他会根据当前路由地址来渲染对应的组件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span>
Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'router-view'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">render</span> <span class="token punctuation">(</span><span class="token parameter">h</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 根据当前路由地址获取到对应的组件并交给 h 函数渲染</span>
        <span class="token keyword">const</span> component <span class="token operator">=</span> self<span class="token punctuation">.</span>routeMap<span class="token punctuation">[</span>self<span class="token punctuation">.</span>data<span class="token punctuation">.</span>current<span class="token punctuation">]</span>
        <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>现在我们打开页面，可以看到组件被正常的渲染出来了</p> <img src="/blog/img/routerview.png" alt="queue" class="custom"> <p>但是当我们点击 About的时候，浏览器刷新了，也就是说它向服务器发送了请求，但是我们不希望他往服务器发送请求，所以我们需要处理一下，</p> <p>router-link 渲染完成后是一个超链接，我们可以给这个超链接添加一个点击事件，让他不去跳转，我们自己去修改地址栏，通过 history.pushState 去修改地址栏，该方法会修改地址栏中的路径，且不会向服务短发送请求</p> <p>然后我们还需要将当前地址记录一下，记录在 data.current 中,因为data 是一个响应式的，所以它会自动渲染对应的视图</p> <p>修改一下 rotuer-link 组件的创建过程</p> <div class="language-js extra-class"><pre class="language-js"><code>Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'router-link'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    props<span class="token operator">:</span> <span class="token punctuation">{</span>
        to<span class="token operator">:</span> String
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// template: '&lt;a :href=&quot;to&quot;&gt;&lt;slot&gt;&lt;/slot&gt;&lt;/a&gt;'</span>
    <span class="token comment">// 参数 h 是 用来创建虚拟 DOM，接收三个参数</span>
    <span class="token comment">// 第一个参数是需要创建的标签名称</span>
    <span class="token comment">// 第二参数是创建标签的一些属性</span>
    <span class="token comment">// 第三个参数是生成的标签元素的子元素，是一个数组的形式</span>
    <span class="token function">render</span> <span class="token punctuation">(</span><span class="token parameter">h</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            attrs<span class="token operator">:</span> <span class="token punctuation">{</span>
                href<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>to
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            on<span class="token operator">:</span> <span class="token punctuation">{</span>
                click<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clickHandler
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">.</span>default<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    methods<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">/**
         * 需要做两件事
         * 1. 修改地址栏路径
         * 2. 加载地址栏路径对应的组件
         */</span>
        <span class="token function">clickHandler</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// pushState 接收三个参数，第一个是 data 是将来触发 popState 时传递给 popState 的参数，我们这里用不到，就传入一个空对象</span>
            <span class="token comment">// 第二个是 title,</span>
            <span class="token comment">// 第三个是 当前超链接要跳转的地址</span>
            history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>to<span class="token punctuation">)</span>
            <span class="token comment">// 加载地址栏对应的组件</span>
            <span class="token comment">// 加载这个组件的是 vue 的实例，我们在前面已经把 $router 挂载到了 vue 实例上，所以可以直接使用</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>$router<span class="token punctuation">.</span>data<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>to
            e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>然后重新启动项目，点击链接，都可以正常跳转并且正常渲染，而且不会向服务端发送请求</p> <h3 id="initevent"><a href="#initevent" class="header-anchor">#</a> initEvent</h3> <p>现在基本功能都实现了，但是还存在一个问题，那就是浏览器中的前进和后退，我们点击前进和后退的时候，地址栏会发生改变，但是组件不会重新渲染</p> <p>接下来就来解决这个问题</p> <p>我们可以调用 popState 方法，这个方法在历史发生改变的时候会被触发，当使用pushState 或者 replaceState 方法是不会触发的</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 注册 popState 事件</span>
<span class="token function">initEvent</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'popstate'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将当前路径记录在 data.current 中</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>current <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>pathname
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 然后在init 方法中调用</span>
<span class="token function">init</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个时候我们的功能就完成了</p> <h3 id="处理浏览器刷新问题"><a href="#处理浏览器刷新问题" class="header-anchor">#</a> 处理浏览器刷新问题</h3> <p>现在还存在一个问题，就是浏览器刷新的时候，渲染的组件和地址栏路径对应不上，这个时候只需要在初始化 components 的时候将浏览器地址赋给 data.current</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">initComponents</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 浏览器刷新的时候 将当前地址栏地址赋给 data.current 这样刷新页面也会渲染出来对应的组件</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>current <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>pathname <span class="token operator">||</span> <span class="token string">'/'</span>
    Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'router-link'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      props<span class="token operator">:</span> <span class="token punctuation">{</span>
        to<span class="token operator">:</span> String
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// template: '&lt;a :href=&quot;to&quot;&gt;&lt;slot&gt;&lt;/slot&gt;&lt;/a&gt;'</span>
      <span class="token comment">// 参数 h 是 用来创建虚拟 DOM，接收三个参数</span>
      <span class="token comment">// 第一个参数是需要创建的标签名称</span>
      <span class="token comment">// 第二参数是创建标签的一些属性</span>
      <span class="token comment">// 第三个参数是生成的标签元素的子元素，是一个数组的形式</span>
      <span class="token function">render</span> <span class="token punctuation">(</span><span class="token parameter">h</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
          attrs<span class="token operator">:</span> <span class="token punctuation">{</span>
            href<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>to
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          on<span class="token operator">:</span> <span class="token punctuation">{</span>
            click<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clickHandler
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">.</span>default<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      methods<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">/**
         * 需要做两件事
         * 1. 修改地址栏路径
         * 2. 加载地址栏路径对应的组件
         */</span>
        <span class="token function">clickHandler</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// pushState 接收三个参数，第一个是 data 是将来触发 popState 时传递给 popState 的参数，我们这里用不到，就传入一个空对象</span>
          <span class="token comment">// 第二个是 title,</span>
          <span class="token comment">// 第三个是 当前超链接要跳转的地址</span>
          history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>to<span class="token punctuation">)</span>
          <span class="token comment">// 加载地址栏对应的组件</span>
          <span class="token comment">// 加载这个组件的是 vue 的实例，我们在前面已经把 $router 挂载到了 vue 实例上，所以可以直接使用</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>$router<span class="token punctuation">.</span>data<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>to
          e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span>
    Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'router-view'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function">render</span> <span class="token punctuation">(</span><span class="token parameter">h</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 根据当前路由地址获取到对应的组件并交给 h 函数渲染</span>
        <span class="token keyword">const</span> component <span class="token operator">=</span> self<span class="token punctuation">.</span>routeMap<span class="token punctuation">[</span>self<span class="token punctuation">.</span>data<span class="token punctuation">.</span>current<span class="token punctuation">]</span>
        <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="完整版代码（history）"><a href="#完整版代码（history）" class="header-anchor">#</a> 完整版代码（history）</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> _Vue <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">VueRouter</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">install</span> <span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. 判断当前插件是否已经安装</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>VueRouter<span class="token punctuation">.</span>install<span class="token punctuation">.</span>installed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    VueRouter<span class="token punctuation">.</span>install<span class="token punctuation">.</span>installed <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token comment">// 2. 把 Vue 构造函数记录到全局</span>
    _Vue <span class="token operator">=</span> Vue
    <span class="token comment">// 3. 把创建 Vue 实例时候传入的 router 对象注入到 Vue 实例上</span>
    <span class="token comment">// 在 new Vue 的时候传入的 router 对象存在于 vue 的 $optoins 中，没有在 Vue 的实例上，所以需要注入到 Vue 的实例上</span>
    <span class="token comment">// 要获取到 $options 中的 router 对象，需要在可以获取到 vue 实例的时候</span>
    <span class="token comment">// 通过使用 混入 在混入的 beforeCreate 我们可以获取到 vue 实例</span>
    _Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// 因为这个混入在所有的实例和组件中都会有且会执行</span>
      <span class="token comment">// 这个钩子函数会被执行很多次，但是这个挂载只需要执行一次</span>
      <span class="token comment">// 所以需要判断需要判断实例上是否有 router 对象，因为组件是则不会有 router 对象</span>
      <span class="token function">beforeCreate</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">_Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router
          <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options
    <span class="token comment">// 存储路径和组件的对应关系</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>routeMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token comment">// data 是一个响应式的对象，因为它需要存储当前的路由地址，当路由地址发生变化的时候需要触发视图更新</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> _Vue<span class="token punctuation">.</span><span class="token function">observable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      current<span class="token operator">:</span> <span class="token string">'/'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">init</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createRouteMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initComponents</span><span class="token punctuation">(</span>_Vue<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">createRouteMap</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 遍历所有的路由规则，把路由规则解析成键值对的，存储到 routeMap 中</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>routeMap<span class="token punctuation">[</span>route<span class="token punctuation">.</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> route<span class="token punctuation">.</span>component
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">initComponents</span> <span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 浏览器刷新的时候 将当前地址栏地址赋给 data.current 这样刷新页面也会渲染出来对应的组件</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>current <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>pathname <span class="token operator">||</span> <span class="token string">'/'</span>
    Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'router-link'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      props<span class="token operator">:</span> <span class="token punctuation">{</span>
        to<span class="token operator">:</span> String
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// template: '&lt;a :href=&quot;to&quot;&gt;&lt;slot&gt;&lt;/slot&gt;&lt;/a&gt;'</span>
      <span class="token comment">// 参数 h 是 用来创建虚拟 DOM，接收三个参数</span>
      <span class="token comment">// 第一个参数是需要创建的标签名称</span>
      <span class="token comment">// 第二参数是创建标签的一些属性</span>
      <span class="token comment">// 第三个参数是生成的标签元素的子元素，是一个数组的形式</span>
      <span class="token function">render</span> <span class="token punctuation">(</span><span class="token parameter">h</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
          attrs<span class="token operator">:</span> <span class="token punctuation">{</span>
            href<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>to
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          on<span class="token operator">:</span> <span class="token punctuation">{</span>
            click<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clickHandler
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">.</span>default<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      methods<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">/**
         * 需要做两件事
         * 1. 修改地址栏路径
         * 2. 加载地址栏路径对应的组件
         */</span>
        <span class="token function">clickHandler</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// pushState 接收三个参数，第一个是 data 是将来触发 popState 时传递给 popState 的参数，我们这里用不到，就传入一个空对象</span>
          <span class="token comment">// 第二个是 title,</span>
          <span class="token comment">// 第三个是 当前超链接要跳转的地址</span>
          history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>to<span class="token punctuation">)</span>
          <span class="token comment">// 加载地址栏对应的组件</span>
          <span class="token comment">// 加载这个组件的是 vue 的实例，我们在前面已经把 $router 挂载到了 vue 实例上，所以可以直接使用</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>$router<span class="token punctuation">.</span>data<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>to
          e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span>
    Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'router-view'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function">render</span> <span class="token punctuation">(</span><span class="token parameter">h</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 根据当前路由地址获取到对应的组件并交给 h 函数渲染</span>
        <span class="token keyword">const</span> component <span class="token operator">=</span> self<span class="token punctuation">.</span>routeMap<span class="token punctuation">[</span>self<span class="token punctuation">.</span>data<span class="token punctuation">.</span>current<span class="token punctuation">]</span>
        <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 注册 popState 事件</span>
  <span class="token function">initEvent</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'popstate'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 将当前路径记录在 data.current 中</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>current <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>pathname
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="有hash模式和history模式的完整版代码"><a href="#有hash模式和history模式的完整版代码" class="header-anchor">#</a> 有hash模式和history模式的完整版代码</h3> <p>因为<code>hash</code>模式和 <code>history</code>实现起来非常类似，这里就只给出代码，相差不大，利用 <code>hashchange</code>就可以了</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">HASH</span> <span class="token operator">=</span> <span class="token string">'hash'</span>
<span class="token keyword">let</span> _Vue <span class="token operator">=</span> <span class="token keyword">null</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">VueRouter</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">install</span> <span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>VueRouter<span class="token punctuation">.</span>install<span class="token punctuation">.</span>installed <span class="token operator">&amp;&amp;</span> _Vue <span class="token operator">===</span> Vue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    VueRouter<span class="token punctuation">.</span>install<span class="token punctuation">.</span>installed <span class="token operator">=</span> <span class="token boolean">true</span>
    _Vue <span class="token operator">=</span> Vue
    Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token function">beforeCreate</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router
          <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options
    <span class="token keyword">this</span><span class="token punctuation">.</span>routeMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mode <span class="token operator">=</span> options<span class="token punctuation">.</span>mode
    <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> _Vue<span class="token punctuation">.</span><span class="token function">observable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      current<span class="token operator">:</span> <span class="token string">'/'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">init</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createRouteMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initComponents</span><span class="token punctuation">(</span>_Vue<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">initComponents</span> <span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span>
    Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'router-link'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      props<span class="token operator">:</span> <span class="token punctuation">{</span>
        to<span class="token operator">:</span> String
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">render</span> <span class="token punctuation">(</span><span class="token parameter">h</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
          attrs<span class="token operator">:</span> <span class="token punctuation">{</span>
            href<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>to
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          on<span class="token operator">:</span> <span class="token punctuation">{</span>
            click<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clickHandler
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">.</span>default<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      methods<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function">clickHandler</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          self<span class="token punctuation">.</span>mode <span class="token operator">===</span> <span class="token constant">HASH</span>
            <span class="token operator">?</span> self<span class="token punctuation">.</span><span class="token function">hashChange</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>to<span class="token punctuation">)</span>
            <span class="token operator">:</span> self<span class="token punctuation">.</span><span class="token function">historyChange</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>to<span class="token punctuation">)</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>$router<span class="token punctuation">.</span>data<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>to
          e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'router-view'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function">render</span> <span class="token punctuation">(</span><span class="token parameter">h</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> component <span class="token operator">=</span> self<span class="token punctuation">.</span>routeMap<span class="token punctuation">[</span>self<span class="token punctuation">.</span>data<span class="token punctuation">.</span>current<span class="token punctuation">]</span>
        <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">createRouteMap</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>routeMap<span class="token punctuation">[</span>route<span class="token punctuation">.</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> route<span class="token punctuation">.</span>component
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">historyChange</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">hashChange</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash <span class="token operator">=</span> path
  <span class="token punctuation">}</span>

  <span class="token comment">// 处理浏览器刷新问题</span>
  <span class="token function">refresh</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mode <span class="token operator">===</span> <span class="token constant">HASH</span>
      <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hashURLHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>current <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>pathname <span class="token operator">||</span> <span class="token string">'/'</span>
  <span class="token punctuation">}</span>

  <span class="token function">hashURLHandle</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash <span class="token operator">=</span> <span class="token string">'/'</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>current <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'/'</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 事件初始化</span>
  <span class="token function">initEvent</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mode <span class="token operator">===</span> <span class="token constant">HASH</span>
      <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initHashEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initHistoryEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">initHistoryEvent</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'popstate'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>current <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>pathname
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">initHashEvent</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'hashchange'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>current <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">2020年8月2日星期日下午3点20分</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/frame/Vue/VirtualDOM.html" class="prev">
        Virtual DOM
      </a></span> <span class="next"><a href="/blog/frame/Vue/base.html">
        Vue
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/blog/assets/js/app.7268b5d5.js" defer></script><script src="/blog/assets/js/2.bfb3ed95.js" defer></script><script src="/blog/assets/js/9.f5c94ac4.js" defer></script><script src="/blog/assets/js/3.38b041cb.js" defer></script>
  </body>
</html>
