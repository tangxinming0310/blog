<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JSONP原理及实现 | 橘子</title>
    <meta name="generator" content="VuePress 1.5.3">
    <link rel="icon" href="/blog/favicon.ico">
    <link rel="manifest" href="/blog/manifest.json">
    <link rel="mask-icon" href="/blog/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <meta name="description" content="明日可期">
    <meta name="author" content="bright">
    <meta name="keywords" content="前端 随记 笔记">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileColor" content="#000000">
    <link rel="preload" href="/blog/assets/css/0.styles.8a31d08e.css" as="style"><link rel="preload" href="/blog/assets/js/app.7268b5d5.js" as="script"><link rel="preload" href="/blog/assets/js/2.bfb3ed95.js" as="script"><link rel="preload" href="/blog/assets/js/11.9b6afde3.js" as="script"><link rel="preload" href="/blog/assets/js/3.38b041cb.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.e22ab2a4.js"><link rel="prefetch" href="/blog/assets/js/12.1881e8b2.js"><link rel="prefetch" href="/blog/assets/js/13.591e9158.js"><link rel="prefetch" href="/blog/assets/js/14.03b9db9c.js"><link rel="prefetch" href="/blog/assets/js/15.8acf6f69.js"><link rel="prefetch" href="/blog/assets/js/16.887430fe.js"><link rel="prefetch" href="/blog/assets/js/17.018b2b77.js"><link rel="prefetch" href="/blog/assets/js/18.dcc85b92.js"><link rel="prefetch" href="/blog/assets/js/19.c9b2a5b0.js"><link rel="prefetch" href="/blog/assets/js/20.cd933d25.js"><link rel="prefetch" href="/blog/assets/js/21.5887b2f8.js"><link rel="prefetch" href="/blog/assets/js/22.5cb0bf92.js"><link rel="prefetch" href="/blog/assets/js/23.bff58062.js"><link rel="prefetch" href="/blog/assets/js/24.145710ef.js"><link rel="prefetch" href="/blog/assets/js/25.6e7a99f7.js"><link rel="prefetch" href="/blog/assets/js/26.6251e442.js"><link rel="prefetch" href="/blog/assets/js/27.2fd5153a.js"><link rel="prefetch" href="/blog/assets/js/28.68c69371.js"><link rel="prefetch" href="/blog/assets/js/4.a5e4891f.js"><link rel="prefetch" href="/blog/assets/js/5.7165873c.js"><link rel="prefetch" href="/blog/assets/js/6.f680b873.js"><link rel="prefetch" href="/blog/assets/js/7.17ca32f2.js"><link rel="prefetch" href="/blog/assets/js/8.7acd39b4.js"><link rel="prefetch" href="/blog/assets/js/9.f5c94ac4.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.8a31d08e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">橘子</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/network/" class="nav-link router-link-active">
  浏览器
</a></div><div class="nav-item"><a href="/blog/note/ES6.html" class="nav-link">
  随记
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/frame/Vue/base.html" class="nav-link">
  Vue
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/network/" class="nav-link router-link-active">
  浏览器
</a></div><div class="nav-item"><a href="/blog/note/ES6.html" class="nav-link">
  随记
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="框架" class="dropdown-title"><span class="title">框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/frame/Vue/base.html" class="nav-link">
  Vue
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>network</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/network/JSONP.html" aria-current="page" class="active sidebar-link">JSONP原理及实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/network/JSONP.html#基本原理" class="sidebar-link">基本原理</a></li><li class="sidebar-sub-header"><a href="/blog/network/JSONP.html#执行过程" class="sidebar-link">执行过程</a></li><li class="sidebar-sub-header"><a href="/blog/network/JSONP.html#优缺点" class="sidebar-link">优缺点</a></li><li class="sidebar-sub-header"><a href="/blog/network/JSONP.html#案列分析" class="sidebar-link">案列分析</a></li><li class="sidebar-sub-header"><a href="/blog/network/JSONP.html#封装一个jsonp方法" class="sidebar-link">封装一个JSONP方法</a></li></ul></li><li><a href="/blog/network/Promise.html" class="sidebar-link">Promise</a></li><li><a href="/blog/network/PromiseTopic.html" class="sidebar-link">Promise由浅入深题目-加深理解</a></li><li><a href="/blog/network/" aria-current="page" class="sidebar-link">浏览器相关</a></li><li><a href="/blog/network/URL.html" class="sidebar-link">输入URL到页面的呈现</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="基本原理"><a href="#基本原理" class="header-anchor">#</a> 基本原理</h2> <p>主要是利用了<code>script</code>标签的<code>src</code>没有跨域限制来实现的</p> <h2 id="执行过程"><a href="#执行过程" class="header-anchor">#</a> 执行过程</h2> <ul><li>前端定义一个解析函数（如：<code>jsonpCallback = function(res) {}</code>）</li> <li>通过<code>params</code>形式包装<code>script</code>标签的请求参数，并且申明执行函数(如：<code>cb=jsonpCallback</code>)</li> <li>后端获取到前端声明的执行函数（<code>jsonpCallback</code>），以带上参数且调用执行函数的放式传递给前端</li> <li>前端在<code>script</code>标签返回资源的时候就会去执行<code>jsonpCallback</code>并通过回调函数的放式拿到数据了</li></ul> <h2 id="优缺点"><a href="#优缺点" class="header-anchor">#</a> 优缺点</h2> <p>优点：</p> <ul><li>兼容性好，在一些古老的浏览器中都可以运行</li></ul> <p>缺点：</p> <ul><li>只能发送<code>GET</code>请求</li></ul> <h2 id="案列分析"><a href="#案列分析" class="header-anchor">#</a> 案列分析</h2> <p>在<code>index.html</code>文件中有如下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
  window<span class="token punctuation">.</span><span class="token function-variable function">jsonpCallback</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;http://127.0.0.1:8888/api/jsonp?id=1&amp;cb=jsonpCallback&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;text/javascript&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>在本地使用<code>node</code>搭建一个小型的测试服务器</p> <p>并且定义一个接口<code>/api/jsonp</code>来返回数据</p> <p>打开<code>index.html</code>文件时就会去加载<code>script</code>标签，并执行了这次请求</p> <p>准备：
1. 新建一个<code>server</code>文件夹
2. 在此目录下<code>npm init -y</code>，初始化<code>package.json</code>文件
3. 安装<code>koa</code>，<code>node</code>轻型框架
4. 新建文件夹<code>src</code>，并且新建<code>index.html</code>和<code>server.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code>mkdir server <span class="token operator">&amp;&amp;</span> cd server
npm init <span class="token operator">-</span>y
npm install <span class="token operator">-</span><span class="token constant">S</span> koa
mkdir src <span class="token operator">&amp;&amp;</span> cd src
touch index<span class="token punctuation">.</span>html
touch server<span class="token punctuation">.</span>js
</code></pre></div><p>搭建小型服务器，代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Koa  <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> datas <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'aria'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'serio'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/api/jsonp'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>cb<span class="token punctuation">,</span> id<span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>query
    <span class="token keyword">const</span> name <span class="token operator">=</span> datas<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>id <span class="token operator">==</span> id<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cb<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">8888</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'SERVER is runing at port:'</span> <span class="token operator">+</span> port<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>然后保存，在<code>src</code>文件夹下面执行：</p> <div class="language-js extra-class"><pre class="language-js"><code>node server<span class="token punctuation">.</span>js
</code></pre></div><p>服务启动后，我们可以看到控制台中会打印出<code>SERVER is runing at port: 8888</code></p> <p>然后我们来写<code>index.html</code>文件中的内容</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  window<span class="token punctuation">.</span><span class="token function-variable function">jsonpCallback</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>http://127.0.0.1:8888/api/jsonp?id=1&amp;cb=jsonpCallback<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>这俩个<code>script</code>的意思是：</p> <ul><li>第一个，创建了一个<code>jsonpCallback</code>函数，但是没有被调用</li> <li>第二个，加载<code>src</code>中的资源，并等待请求的内容返回</li></ul> <p>整个过程就是：</p> <ol><li>当执行到第二个<code>script</code>的时候，由于请求了我们的<code>8888</code>端口，并且把<code>id</code>和<code>cb</code>这两个参数放到<code>URL</code>里。那么后台就可以拿到<code>URL</code>里的这两个参数。</li></ol> <div class="language- extra-class"><pre><code>也就是在后端代码中的`const { id, cb } = ctx.query`这里获取到了。
</code></pre></div><ol start="2"><li><p>后端在拿到这两个参数之后，可能就会根据<code>id</code>来进行一些查询，这里只是模拟的查询，用了一个简单的<code>find</code>来进行一个查找。查找到<code>id</code>为1的那项并且取<code>name</code>。</p></li> <li><p>第二个参数<code>cb</code>，拿到的就是<code>&quot;jsonpCallback&quot;</code>了，这里也就是告诉后端，前端那里是会有一个叫做<code>jsonpCallback</code>的函数来接收后端想要返回的数据，而后端你只需要在返回体中写入<code>jsonpCallback()</code>就可以了。</p></li> <li><p>前端在得到了后端返回的内容<code>jsonpCallback({&quot;name&quot;:&quot;aria&quot;})</code>，发现里面是一段执行函数的语句，因此就会去执行第一个<code>script</code>中的<code>jsonpCallback</code>方法了，并且又是带了参数的，所以此时浏览器控制台会打印出<code>{ name: 'aria' }</code></p></li></ol> <h2 id="封装一个jsonp方法"><a href="#封装一个jsonp方法" class="header-anchor">#</a> 封装一个JSONP方法</h2> <h3 id="简单版"><a href="#简单版" class="header-anchor">#</a> 简单版</h3> <p>定义一个<code>JSONP</code>方法，接收四个参数</p> <ul><li>url</li> <li>params</li> <li>callbackKey 回调函数名称</li> <li>callback 拿到数据后执行的回调函数</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token constant">JSONP</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  url<span class="token punctuation">,</span>
  params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  callbackKey <span class="token operator">=</span> <span class="token string">'cb'</span><span class="token punctuation">,</span>
  callback
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 定义本地callback的名称</span>
  <span class="token keyword">const</span> callbackName <span class="token operator">=</span> <span class="token string">'jsonpCallback'</span>
  <span class="token comment">// 将这个名称加入到params中</span>
  params<span class="token punctuation">[</span>callbackKey<span class="token punctuation">]</span> <span class="token operator">=</span> callbackName
  <span class="token comment">// 将这个callback加入到window对象中，这样就可以执行这个回调了</span>
  window<span class="token punctuation">[</span>callbackName<span class="token punctuation">]</span> <span class="token operator">=</span> callback

  <span class="token comment">// 获取参数字符串'id=1&amp;&amp;cb=jsonpCallback'</span>
  <span class="token keyword">const</span> paramString <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'&amp;'</span><span class="token punctuation">)</span>

  <span class="token comment">// 创建script标签</span>
  <span class="token keyword">const</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span>
  script<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>paramString<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// test</span>
<span class="token constant">JSONP</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  url<span class="token operator">:</span> <span class="token string">'http://localhost:8888/api/jsonp'</span><span class="token punctuation">,</span>
  params<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  callbackKey<span class="token operator">:</span> <span class="token string">'cb'</span><span class="token punctuation">,</span>
  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这样已经简单实现了<code>JSONP</code>，但是存在一个问题，就是当我们同时多次调用<code>JSONP</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">JSONP</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  url<span class="token operator">:</span> <span class="token string">'http://localhost:8888/api/jsonp'</span><span class="token punctuation">,</span>
  params<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  callbackKey<span class="token operator">:</span> <span class="token string">'cb'</span><span class="token punctuation">,</span>
  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token comment">// 1</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token constant">JSONP</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  url<span class="token operator">:</span> <span class="token string">'http://localhost:8888/api/jsonp'</span><span class="token punctuation">,</span>
  params<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  callbackKey<span class="token operator">:</span> <span class="token string">'cb'</span><span class="token punctuation">,</span>
  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token comment">// 2</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这里调用了两次<code>JSONP</code>，只是传递的参数不同。但是并不会按我们预期的在<code>1</code>和<code>2</code>中分别打印，而是都会在<code>2</code>中打印出结果。这是因为后面一个<code>callback</code>把<code>JSONP</code>里封装的第一个<code>callback</code>给覆盖了，它们都是共用的同一个<code>callbackName</code>，也就是<code>jsonpCallback</code></p> <h3 id="进阶版"><a href="#进阶版" class="header-anchor">#</a> 进阶版</h3> <p>我们对这个方法进行一个改造:</p> <ul><li>使得<code>callbackName</code>唯一</li> <li>不把回调挂在在<code>window</code>中，这样有可能会污染全局变量，放在<code>JSONP</code>的属性中，(<code>JSONP.xxx</code>)</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token constant">JSONP</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  url<span class="token punctuation">,</span>
  params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  callbackKey <span class="token operator">=</span> <span class="token string">'cb'</span><span class="token punctuation">,</span>
  callback
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 定义本地唯一callbackId,没有则初始化为1</span>
  <span class="token constant">JSONP</span><span class="token punctuation">.</span>callbackId <span class="token operator">=</span> <span class="token constant">JSONP</span><span class="token punctuation">.</span>callbackId <span class="token operator">||</span> <span class="token number">1</span>
  <span class="token keyword">let</span> callbackId <span class="token operator">=</span> <span class="token constant">JSONP</span><span class="token punctuation">.</span>callbackId
  <span class="token comment">// 把要执行的回调加入到JSONP对象中</span>
  <span class="token constant">JSONP</span><span class="token punctuation">.</span>callbacks <span class="token operator">=</span> <span class="token constant">JSONP</span><span class="token punctuation">.</span>callbacks <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token constant">JSONP</span><span class="token punctuation">.</span>callbacks<span class="token punctuation">[</span>callbackId<span class="token punctuation">]</span> <span class="token operator">=</span> callback
  <span class="token comment">// 将名称加入到参数中</span>
  params<span class="token punctuation">[</span>callbackKey<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">JSONP.callbacks[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>callbackId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]</span><span class="token template-punctuation string">`</span></span>

  <span class="token comment">// 获取参数字符串`id=1&amp;cb=JSONP.callbacks[1]`</span>
  <span class="token keyword">const</span> paramString <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'&amp;'</span><span class="token punctuation">)</span>
  <span class="token comment">// 创建script标签</span>
  <span class="token keyword">const</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span>
  script<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>paramString<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span>
  <span class="token comment">// id自增</span>
  <span class="token constant">JSONP</span><span class="token punctuation">.</span>callbackId<span class="token operator">++</span>
<span class="token punctuation">}</span>
<span class="token comment">// test</span>
  <span class="token constant">JSONP</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    url<span class="token operator">:</span> <span class="token string">'http://localhost:8080/api/jsonp'</span><span class="token punctuation">,</span>
    params<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    callbackKey<span class="token operator">:</span> <span class="token string">'cb'</span><span class="token punctuation">,</span>
    <span class="token function">callback</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token constant">JSONP</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    url<span class="token operator">:</span> <span class="token string">'http://localhost:8080/api/jsonp'</span><span class="token punctuation">,</span>
    params<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    callbackKey<span class="token operator">:</span> <span class="token string">'cb'</span><span class="token punctuation">,</span>
    <span class="token function">callback</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>现在调用了俩次JSONP，但是会分别执行<code>JSONP.callbacks[1]</code>和<code>JSONP.callbacks[2]</code></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">2020年5月20日星期三下午12点44分</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/blog/network/Promise.html">
        Promise
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/blog/assets/js/app.7268b5d5.js" defer></script><script src="/blog/assets/js/2.bfb3ed95.js" defer></script><script src="/blog/assets/js/11.9b6afde3.js" defer></script><script src="/blog/assets/js/3.38b041cb.js" defer></script>
  </body>
</html>
